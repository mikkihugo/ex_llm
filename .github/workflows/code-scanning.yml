name: Code Scanning (Singularity Scanner)

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  security-events: write

concurrency:
  group: code-scanning-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scan:
    name: Run Singularity Scanner and upload SARIF
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .

      - name: Build scanner (CLI)
        run: |
          cargo build --release -p code_quality_engine --no-default-features --features cli

      - name: Run scanner (SARIF)
        run: |
          TARGET="."
          echo "Scanning path: $TARGET"
          ./target/release/singularity-scanner analyze --path "$TARGET" --format sarif > singularity.sarif

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: singularity.sarif
          category: singularity-scanner

      - name: Fail PR on high severity (error) findings
        run: |
          ERRORS=$(jq '[.runs[0].results[] | select(.level == "error")] | length' singularity.sarif)
          echo "High severity findings: ${ERRORS}"
          if [ "$ERRORS" -gt 0 ]; then
            echo "Blocking PR due to high severity findings"
            exit 1
          fi

name: Claude Code PR Review (Simplified)

on:
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: |
          bun install

      - name: Run Claude Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Get PR details
          PR_DIFF=$(gh pr diff $PR_NUMBER)
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q .title)
          PR_BODY=$(gh pr view $PR_NUMBER --json body -q .body)

          # Extract task from comment (remove @claude trigger)
          TASK=$(echo "$COMMENT_BODY" | sed 's/@claude //g' | sed 's/@claude$//g')
          if [ -z "$TASK" ] || [ "$TASK" = "$COMMENT_BODY" ]; then
            TASK="Review this PR for code quality, architectural issues, and suggest improvements."
          fi

          # Create review request
          cat > /tmp/review_request.md <<'EOF'
# PR Review Request

**PR #${PR_NUMBER}: ${PR_TITLE}**

## Description
${PR_BODY}

## Task
${TASK}

## Changes
```diff
${PR_DIFF}
```

Please provide:
1. Code quality assessment
2. Architectural concerns
3. Specific code changes needed (if any)
4. Approval status (APPROVE / REQUEST_CHANGES / COMMENT)
EOF

          # Expand variables
          eval "cat <<EVAL_EOF
          $(cat /tmp/review_request.md)
EVAL_EOF
" > /tmp/review_final.md

          # Run Claude Code review
          export CLAUDE_API_KEY="$CLAUDE_CODE_OAUTH_TOKEN"

          REVIEW_OUTPUT=$(bun run tools/claude-ai.ts "$(cat <<EOJSON
{
  "model": "sonnet",
  "messages": [
    {
      "role": "user",
      "content": $(cat /tmp/review_final.md | jq -Rs .)
    }
  ],
  "temperature": 0.3
}
EOJSON
)" | jq -r .text)

          # Post review as comment
          gh pr comment $PR_NUMBER --body "$REVIEW_OUTPUT"

          echo "âœ… Review posted to PR #$PR_NUMBER"

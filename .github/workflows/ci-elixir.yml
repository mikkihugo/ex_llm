name: CI (Elixir + Gleam via Nix + Cachix)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  nix-setup:
    uses: ./.github/workflows/nix-setup.yml
    secrets: inherit
    with:
      cachix_push: true
      cache_key_prefix: 'ci-otp28-elixir1184'

  build-test:
    needs: nix-setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Nix
        uses: cachix/install-nix-action@a809471b5c7c913aa67bec8f459a11a0decc3fce # v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Use Cachix (pull)
        uses: cachix/cachix-action@ad2ddac53f961de1989924296a1f236fcfbaa4fc # v15
        with:
          name: mikkihugo

      - name: Restore Mix/Hex and Moon cache
        uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # v4.2.2
        with:
          path: |
            singularity_app/.mix
            singularity_app/.hex
            singularity_app/deps
            singularity_app/_build
            .cargo-build
            .moon/cache
          key: ci-otp28-elixir1184-${{ runner.os }}-${{ hashFiles('singularity_app/mix.lock') }}-${{ hashFiles('**/moon.yml') }}
          restore-keys: |
            ci-otp28-elixir1184-${{ runner.os }}-

      - name: Fetch deps (Mix + Gleam)
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix deps.get
          '

      - name: Compile (Elixir + Gleam)
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix compile
          '

      - name: Build Nix packages (Rust/BEAM)
        run: |
          SYSTEM=$(nix eval --raw --expr builtins.currentSystem)
          nix build .#packages.$SYSTEM.ai-server --out-link /tmp/ai-server-result -L || echo "ai-server package build skipped"

      - name: Format & Lint
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix format --check-formatted
            cd singularity_app && mix credo --strict
          '

      - name: Security & Dependency Audit
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix deps.audit
          '

      - name: Run tests (Elixir)
        env:
          MIX_ENV: test
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix test --color
          '

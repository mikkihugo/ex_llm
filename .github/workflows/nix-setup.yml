name: Nix Setup (Reusable)

on:
  workflow_call:
    inputs:
      cachix_push:
        description: 'Build and push Nix outputs to Cachix (requires token)'
        required: false
        default: false
        type: boolean
      cache_key_prefix:
        description: 'Prefix for actions/cache key'
        required: false
        default: 'ci'
        type: string
    secrets:
      CACHIX_AUTH_TOKEN:
        description: 'Cachix authentication token'
        required: false

jobs:
  nix-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Runner debug info
        run: |
          set -x
          uname -a
          cat /etc/os-release || true
          env | sort | sed -e 's/\(GITHUB_TOKEN\|CACHIX_AUTH_TOKEN\)=.*/\1=***REDACTED***/'
      - name: Install Nix
        uses: cachix/install-nix-action@a809471b5c7c913aa67bec8f459a11a0decc3fce # v31 tag
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Use Cachix (pull; push if token)
        uses: cachix/cachix-action@ad2ddac53f961de1989924296a1f236fcfbaa4fc # v15
        with:
          name: mikkihugo
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Nix/Cachix diagnostics
        run: |
          set -x
          which nix
          nix --version
          nix registry list || true
          echo "NIX_CONFIG:$NIX_CONFIG" | sed 's/\(CACHIX_AUTH_TOKEN\)=.*/\1=***REDACTED***/'
          test -f /etc/nix/nix.conf && sed 's/token = .*/token = ***REDACTED***/' /etc/nix/nix.conf || true
          nix doctor || true

      - name: Show toolchain versions (OTP via flake)
        run: |
          nix develop -c bash -lc '
            elixir -v | head -n2
            echo OTP: $(erl -eval "erlang:display(erlang:system_info(otp_release)), halt()." -noshell)
            gleam --version
          '

      - name: Cache Mix/Hex, Moon, and Bun node_modules
        uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # v4.2.2
        with:
          path: |
            singularity_app/.mix
            singularity_app/.hex
            singularity_app/deps
            singularity_app/_build
            .cargo-build
            .moon/cache
            ai-server/node_modules
          key: ${{ inputs.cache_key_prefix }}-${{ runner.os }}-${{ hashFiles('singularity_app/mix.lock') }}-${{ hashFiles('**/moon.yml') }}-${{ hashFiles('ai-server/bun.lock*') }}
          restore-keys: |
            ${{ inputs.cache_key_prefix }}-${{ runner.os }}-

      - name: Build and push dev shell (Cachix)
        if: inputs.cachix_push == true
        run: |
          SYSTEM=$(nix eval --raw --expr builtins.currentSystem)
          # Use nix build with --out-link to avoid rebuilds
          nix build .#devShells.$SYSTEM.default --out-link /tmp/devshell-result -L
          cachix push mikkihugo /tmp/devshell-result

      - name: Build and push Nix packages (Cachix)
        if: inputs.cachix_push == true
        run: |
          SYSTEM=$(nix eval --raw --expr builtins.currentSystem)
          nix build .#packages.$SYSTEM.ai-server --out-link /tmp/ai-server-result -L || true
          if [ -e /tmp/ai-server-result ]; then cachix push mikkihugo /tmp/ai-server-result; fi
          
          nix build .#packages.$SYSTEM.singularity-integrated --out-link /tmp/singularity-result -L || true
          if [ -e /tmp/singularity-result ]; then cachix push mikkihugo /tmp/singularity-result; fi

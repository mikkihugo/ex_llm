name: Claude Code PR Review (BEAM)

on:
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Setup BEAM (Elixir + Gleam + OTP)
        uses: erlef/setup-beam@v1
        with:
          otp-version: '28'
          elixir-version: '1.18.4'
          gleam-version: '1.12.0'

      - name: Setup Bun (TypeScript)
        uses: oven-sh/setup-bun@v2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify environment
        run: |
          echo "=== Environment Check ==="
          echo "Elixir: $(elixir --version | head -1)"
          echo "Gleam: $(gleam --version)"
          echo "OTP: $(erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().' -noshell)"
          echo "Bun: $(bun --version)"
          echo "Rust: $(rustc --version)"

      - name: Install dependencies
        run: |
          bun install

      - name: Use Cachix (pull; push if token)
        uses: cachix/cachix-action@v14
        with:
          name: mikkihugo
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Cache Mix/Hex and Moon (PR review)
        uses: actions/cache@v4
        with:
          path: |
            singularity_app/.mix
            singularity_app/.hex
            singularity_app/deps
            singularity_app/_build
            .moon/cache
          key: pr-${{ runner.os }}-otp28-elixir1184-${{ hashFiles('singularity_app/mix.lock') }}-${{ hashFiles('**/moon.yml') }}
          restore-keys: |
            pr-${{ runner.os }}-otp28-elixir1184-

      - name: Run Claude Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Get PR details
          PR_DIFF=$(gh pr diff $PR_NUMBER)
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q .title)
          PR_BODY=$(gh pr view $PR_NUMBER --json body -q .body)

          # Extract task from comment (remove @claude trigger)
          TASK=$(echo "$COMMENT_BODY" | sed 's/@claude //g' | sed 's/@claude$//g')
          if [ -z "$TASK" ] || [ "$TASK" = "$COMMENT_BODY" ]; then
            TASK="Review this PR for code quality, architectural issues, and suggest improvements."
          fi

          # Create review request
          cat > /tmp/review_request.md <<'HEREDOC'
# PR Review Request

**PR #${PR_NUMBER}: ${PR_TITLE}**

## Description
${PR_BODY}

## Task
${TASK}

## Changes
```diff
${PR_DIFF}
```

Please provide:
1. Code quality assessment (Elixir, Gleam, Rust, TypeScript)
2. Architectural concerns
3. Specific code changes needed (if any)
4. Approval status (APPROVE / REQUEST_CHANGES / COMMENT)

If you REQUEST_CHANGES, tag @Copilot to fix the issues.
HEREDOC

          # Expand variables
          eval "cat <<EVALEOF
$(cat /tmp/review_request.md)
EVALEOF
" > /tmp/review_final.md

          # Run Claude Code review
          export CLAUDE_API_KEY="$CLAUDE_CODE_OAUTH_TOKEN"

          REVIEW_OUTPUT=$(bun run tools/claude-ai.ts "$(cat <<EOJSON
{
  "model": "sonnet",
  "messages": [
    {
      "role": "user",
      "content": $(cat /tmp/review_final.md | jq -Rs .)
    }
  ],
  "temperature": 0.3
}
EOJSON
)" | jq -r .text)

          # Post review as comment
          gh pr comment $PR_NUMBER --body "$REVIEW_OUTPUT"

          echo "âœ… Review posted to PR #$PR_NUMBER"

          # Auto-merge if Claude approves
          if echo "$REVIEW_OUTPUT" | grep -qi "APPROVE"; then
            echo "ðŸŽ¯ Claude approved! Checking if PR can be merged..."

            # Check if PR is mergeable
            PR_STATUS=$(gh pr view $PR_NUMBER --json mergeable,mergeStateStatus --jq '{mergeable, state: .mergeStateStatus}')
            MERGEABLE=$(echo "$PR_STATUS" | jq -r '.mergeable')
            STATE=$(echo "$PR_STATUS" | jq -r '.state')

            if [ "$MERGEABLE" = "MERGEABLE" ] && [ "$STATE" = "CLEAN" ]; then
              echo "âœ… PR is ready - auto-merging..."
              gh pr merge $PR_NUMBER --squash --auto --delete-branch
              gh pr comment $PR_NUMBER --body "âœ… **Auto-merged by Claude Code**

This PR was automatically merged after Claude approval."
            else
              echo "âš ï¸ PR not ready to merge (mergeable: $MERGEABLE, state: $STATE)"
              gh pr comment $PR_NUMBER --body "â„¹ï¸ Claude approved this PR, but auto-merge is waiting for:
- âœ… All checks to pass
- âœ… No merge conflicts
- âœ… Branch protection satisfied

Will auto-merge when ready, or you can merge manually."
            fi

          # Tag Copilot if changes requested
          elif echo "$REVIEW_OUTPUT" | grep -qi "REQUEST_CHANGES"; then
            echo "ðŸ”§ Claude requested changes - tagging Copilot..."
            gh pr comment $PR_NUMBER --body "@Copilot Claude requested changes to this PR. Please address the issues mentioned in the review above and request another review when ready."
          fi

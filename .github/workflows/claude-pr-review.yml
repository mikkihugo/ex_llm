name: Claude Code PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # Only run on PRs or PR comments that mention @claude
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Install Bun
        run: |
          nix develop .#dev --command bash -c "bun --version"

      - name: Run Claude Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          nix develop .#dev --command bash -c '
            # Install Claude Code CLI via bun
            export CLAUDE_API_KEY="$CLAUDE_CODE_OAUTH_TOKEN"

            # Get PR details
            PR_DIFF=$(gh pr diff $PR_NUMBER)
            PR_TITLE=$(gh pr view $PR_NUMBER --json title -q .title)
            PR_BODY=$(gh pr view $PR_NUMBER --json body -q .body)

            # Check if this is a comment request
            if [ -n "$COMMENT_BODY" ]; then
              TASK="$COMMENT_BODY"
            else
              TASK="Review this PR for code quality, architectural issues, and suggest improvements."
            fi

            # Create review request
            cat > /tmp/review_request.md <<EOF
            # PR Review Request

            **PR #$PR_NUMBER: $PR_TITLE**

            ## Description
            $PR_BODY

            ## Task
            $TASK

            ## Changes
            \`\`\`diff
            $PR_DIFF
            \`\`\`

            Please provide:
            1. Code quality assessment
            2. Architectural concerns (reference docs/development/PR_2_REVIEW.md for review standards)
            3. Specific code changes needed (if any)
            4. Approval status (APPROVE / REQUEST_CHANGES / COMMENT)
            EOF

            # Run Claude Code review
            REVIEW_OUTPUT=$(bun run tools/claude-ai.ts "$(cat <<EOJSON
            {
              "model": "sonnet",
              "messages": [
                {
                  "role": "user",
                  "content": "$(cat /tmp/review_request.md)"
                }
              ]
            }
            EOJSON
            )" | jq -r .text)

            # Post review as comment
            gh pr comment $PR_NUMBER --body "$REVIEW_OUTPUT"

            # Check if review suggests changes
            if echo "$REVIEW_OUTPUT" | grep -q "REQUEST_CHANGES"; then
              echo "::warning::Claude Code requested changes on PR #$PR_NUMBER"
            fi
          '

      - name: Apply fixes if requested
        if: contains(github.event.comment.body, '@claude fix')
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          nix develop .#dev --command bash -c '
            export CLAUDE_API_KEY="$CLAUDE_CODE_OAUTH_TOKEN"

            # Extract fix instructions from comment
            FIX_INSTRUCTIONS=$(echo "$COMMENT_BODY" | sed "s/@claude fix//g")

            # Get PR details and files
            PR_FILES=$(gh pr view $PR_NUMBER --json files -q ".files[].path")

            # Create fix request
            cat > /tmp/fix_request.md <<EOF
            # PR Fix Request

            ## Instructions
            $FIX_INSTRUCTIONS

            ## Files in PR
            $PR_FILES

            Please provide the exact code changes needed as a series of file edits.
            Format each change as:

            FILE: path/to/file
            CHANGE: description
            \`\`\`language
            // exact code to replace or add
            \`\`\`
            EOF

            # Get fix suggestions from Claude
            FIXES=$(bun run tools/claude-ai.ts "$(cat <<EOJSON
            {
              "model": "sonnet",
              "messages": [
                {
                  "role": "user",
                  "content": "$(cat /tmp/fix_request.md)"
                }
              ]
            }
            EOJSON
            )" | jq -r .text)

            # Post fixes as comment
            gh pr comment $PR_NUMBER --body "## ðŸ¤– Claude Code Suggested Fixes\n\n$FIXES\n\n---\n*To apply these fixes, the PR author should review and commit them manually.*"
          '

name: CI (Nix Build)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  nix-setup:
    uses: ./.github/workflows/nix-setup.yml
    secrets:
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
    with:
      cachix_push: true
      cache_key_prefix: 'ci-otp28-elixir1184'

  build-test:
    needs: nix-setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Restore all build artifacts (Mix, Cargo, Moon, Bun)
        uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # v4.2.2
        with:
          path: |
            **/.mix
            **/.hex
            **/deps
            **/_build
            .cargo-build
            .moon/cache
            **/node_modules
          key: ci-otp28-elixir1184-${{ runner.os }}-${{ hashFiles('**/mix.lock') }}-${{ hashFiles('**/moon.yml') }}-${{ hashFiles('**/bun.lock*') }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ci-otp28-elixir1184-${{ runner.os }}-

      - name: Fetch deps (Mix + Gleam)
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix deps.get
          '

      - name: Compile (Elixir + Gleam)
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix compile
          '

      - name: Build Nix packages (Rust/BEAM)
        run: |
          SYSTEM=$(nix eval --raw --impure --expr 'builtins.currentSystem')
          nix build .#packages.$SYSTEM.ai-server --out-link /tmp/ai-server-result -L || echo "ai-server package build skipped"

      - name: Format & Lint
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix format --check-formatted
            cd singularity_app && mix credo --strict
          '

      - name: Security & Dependency Audit
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix deps.audit
          '

      - name: Run tests (Elixir)
        env:
          MIX_ENV: test
        run: |
          nix develop -c bash -lc '
            cd singularity_app && mix test --color
          '

name: Deploy Seed Agent OCI

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      FLY_APP: seed-agent
    steps:
      - uses: actions/checkout@v4

      - name: Maximize disk space for Nix
        uses: wimpysworld/nothing-but-nix@main

      - name: Install Nix
        uses: cachix/install-nix-action@a809471b5c7c913aa67bec8f459a11a0decc3fce # v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Use Cachix (pull)
        uses: cachix/cachix-action@master
        with:
          name: mikkihugo

      - name: Build OCI image
        run: nix build .#seed-agent-oci

      - name: Install podman and flyctl
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Log in to Fly registry
        run: |
          fly auth token ${FLY_API_TOKEN}
          fly registry login

      - name: Push image to Fly registry
        run: |
          podman load < result
          podman tag seed-agent:latest registry.fly.io/${FLY_APP}:${GITHUB_SHA}
          podman push registry.fly.io/${FLY_APP}:${GITHUB_SHA}

      - name: Deploy
        run: |
          fly deploy --app ${FLY_APP} --image registry.fly.io/${FLY_APP}:${GITHUB_SHA} --detach

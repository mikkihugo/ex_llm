<div class="min-h-screen bg-gray-50 p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-bold text-gray-900">üí∞ Cost Analytics Dashboard</h1>
        <button
          phx-click="refresh"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          üîÑ Refresh
        </button>
      </div>
      <p class="text-gray-600">Real-time spending trends, provider comparison, and cost forecasting</p>
    </div>

    <!-- Loading State -->
    <%= if @loading do %>
      <div class="flex items-center justify-center h-64">
        <div class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-gray-600">Loading cost metrics...</p>
        </div>
      </div>
    <% else %>
      <!-- Error State -->
      <%= if @error do %>
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
          <p class="text-red-800">‚ö†Ô∏è Error: <%= @error %></p>
        </div>
      <% else %>
        <!-- Dashboard Content -->
        <%= if @dashboard do %>
          <!-- Overview Cards -->
          <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Total Cost -->
              <div class="bg-white rounded-lg shadow-md p-6">
                <p class="text-sm text-gray-600 mb-2">Total Spending</p>
                <p class="text-3xl font-bold text-green-600">
                  $<%= format_cost(@dashboard.total_cost_cents) %>
                </p>
                <p class="text-xs text-gray-500 mt-2">All time</p>
              </div>

              <!-- Monthly Forecast -->
              <div class="bg-white rounded-lg shadow-md p-6">
                <p class="text-sm text-gray-600 mb-2">Forecasted Monthly Cost</p>
                <p class="text-3xl font-bold text-blue-600">
                  $<%= format_cost(@dashboard.forecasted_monthly_cost_cents) %>
                </p>
                <p class="text-xs text-gray-500 mt-2">Based on recent trends</p>
              </div>

              <!-- Token Efficiency -->
              <div class="bg-white rounded-lg shadow-md p-6">
                <p class="text-sm text-gray-600 mb-2">Total Tokens Used</p>
                <p class="text-3xl font-bold text-purple-600">
                  <%= if @dashboard.token_efficiency && length(@dashboard.token_efficiency) > 0 do %>
                    <%= @dashboard.token_efficiency
                    |> Enum.map(& &1.total_tokens)
                    |> Enum.sum()
                    |> Kernel.div(1)
                    |> Number.Delimit.number_to_delimited() %>
                  <% else %>
                    N/A
                  <% end %>
                </p>
                <p class="text-xs text-gray-500 mt-2">Across all providers</p>
              </div>
            </div>
          </section>

          <!-- Cost by Provider -->
          <%= if @dashboard.cost_by_provider && length(@dashboard.cost_by_provider) > 0 do %>
            <section class="mb-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Cost by Provider</h2>
              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="space-y-4">
                  <%= for provider <- @dashboard.cost_by_provider do %>
                    <div class="border-b border-gray-200 pb-4 last:border-b-0">
                      <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-900">
                          <%= provider.provider |> String.upcase() %>
                        </span>
                        <span class="text-lg font-bold text-blue-600">
                          $<%= format_cost(provider.total_cost_cents) %>
                        </span>
                      </div>
                      <div class="flex justify-between text-sm text-gray-600">
                        <span>Executions: <%= provider.execution_count %></span>
                        <span>Avg: $<%= format_cost(provider.avg_cost_per_execution) %></span>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>

          <!-- Cost by Model -->
          <%= if @dashboard.cost_by_model && length(@dashboard.cost_by_model) > 0 do %>
            <section class="mb-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Top Models by Cost</h2>
              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="space-y-3">
                  <%= for model <- Enum.take(@dashboard.cost_by_model, 5) do %>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                      <div>
                        <p class="font-semibold text-gray-900"><%= model.model %></p>
                        <p class="text-sm text-gray-600"><%= model.provider %> ‚Ä¢ <%= model.execution_count %> calls</p>
                      </div>
                      <div class="text-right">
                        <p class="font-bold text-blue-600">$<%= format_cost(model.total_cost_cents) %></p>
                        <p class="text-xs text-gray-600"><%= model.total_tokens || 0 %> tokens</p>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>

          <!-- Daily Spending Trend -->
          <%= if @dashboard.time_series_daily && length(@dashboard.time_series_daily) > 0 do %>
            <section class="mb-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Daily Spending Trend</h2>
              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="space-y-3">
                  <%= for day <- Enum.take(@dashboard.time_series_daily, -7) do %>
                    <div class="flex justify-between items-center pb-3 border-b border-gray-200 last:border-b-0">
                      <span class="text-gray-600"><%= day.date %></span>
                      <div class="flex items-center gap-4">
                        <div class="text-right">
                          <p class="font-semibold text-gray-900">$<%= format_cost(day.total_cost_cents) %></p>
                          <p class="text-sm text-gray-600"><%= day.execution_count %> tasks</p>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>

          <!-- Last Updated -->
          <div class="text-sm text-gray-500 text-right">
            Last updated: <%= @dashboard.timestamp |> DateTime.truncate(:second) |> DateTime.to_string() %>
          </div>
        <% else %>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
            <p class="text-gray-600">No cost data available</p>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

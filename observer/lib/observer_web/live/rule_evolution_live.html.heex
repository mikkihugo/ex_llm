<div class="min-h-screen bg-gray-50 p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-bold text-gray-900">üìú Rule Evolution Timeline</h1>
        <button
          phx-click="refresh"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          üîÑ Refresh
        </button>
      </div>
      <p class="text-gray-600">Visual progression of rules through promotion stages and effectiveness metrics</p>
    </div>

    <!-- Loading State -->
    <%= if @loading do %>
      <div class="flex items-center justify-center h-64">
        <div class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-gray-600">Loading rule evolution metrics...</p>
        </div>
      </div>
    <% else %>
      <!-- Error State -->
      <%= if @error do %>
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
          <p class="text-red-800">‚ö†Ô∏è Error: <%= @error %></p>
        </div>
      <% else %>
        <!-- Dashboard Content -->
        <%= if @dashboard do %>
          <!-- Rule Counts by Stage -->
          <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Rules by Stage</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <%= if @dashboard.rule_counts do %>
                <!-- Total Rules -->
                <div class="bg-white rounded-lg shadow-md p-6">
                  <p class="text-sm text-gray-600 mb-2">Total Rules</p>
                  <p class="text-4xl font-bold text-gray-900">
                    <%= @dashboard.rule_counts.total %>
                  </p>
                </div>

                <!-- High Confidence -->
                <div class="bg-white rounded-lg shadow-md p-6">
                  <p class="text-sm text-gray-600 mb-2">High Confidence (‚â•90%)</p>
                  <p class="text-4xl font-bold text-green-600">
                    <%= @dashboard.rule_counts.high_confidence %>
                  </p>
                  <p class="text-xs text-gray-600 mt-2">Ready for publishing</p>
                </div>

                <!-- Medium Confidence -->
                <div class="bg-white rounded-lg shadow-md p-6">
                  <p class="text-sm text-gray-600 mb-2">Medium Confidence (70-90%)</p>
                  <p class="text-4xl font-bold text-yellow-600">
                    <%= @dashboard.rule_counts.medium_confidence %>
                  </p>
                  <p class="text-xs text-gray-600 mt-2">Improving</p>
                </div>

                <!-- Low Confidence -->
                <div class="bg-white rounded-lg shadow-md p-6">
                  <p class="text-sm text-gray-600 mb-2">Low Confidence (<70%)</p>
                  <p class="text-4xl font-bold text-orange-600">
                    <%= @dashboard.rule_counts.low_confidence %>
                  </p>
                  <p class="text-xs text-gray-600 mt-2">Candidates</p>
                </div>
              <% end %>
            </div>
          </section>

          <!-- Confidence Distribution -->
          <%= if @dashboard.confidence_distribution && length(@dashboard.confidence_distribution) > 0 do %>
            <section class="mb-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Confidence Distribution</h2>
              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="space-y-3">
                  <%= for dist <- Enum.reverse(@dashboard.confidence_distribution) do %>
                    <div class="flex items-center gap-4">
                      <div class="w-32 text-sm font-semibold text-gray-700">
                        <%= dist.confidence_range %>
                      </div>
                      <div class="flex-1 bg-gray-200 rounded-full h-8 overflow-hidden">
                        <div
                          class="bg-gradient-to-r from-blue-500 to-green-500 h-full flex items-center justify-end pr-3"
                          style={"width: #{dist.percentage}%"}
                        >
                          <span class="text-white text-sm font-bold">
                            <%= Float.round(dist.percentage, 1) %>%
                          </span>
                        </div>
                      </div>
                      <div class="w-20 text-right text-sm text-gray-600">
                        <%= dist.count %> rules
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>

          <!-- Recent Promotions -->
          <%= if @dashboard.recent_promotions && length(@dashboard.recent_promotions) > 0 do %>
            <section class="mb-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Recent Promotions (Last 7 Days)</h2>
              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="space-y-4">
                  <%= for promotion <- Enum.take(@dashboard.recent_promotions, 10) do %>
                    <div class="border-b border-gray-200 pb-4 last:border-b-0">
                      <div class="flex justify-between items-start">
                        <div>
                          <p class="font-semibold text-gray-900"><%= promotion.name %></p>
                          <p class="text-sm text-gray-600">
                            <%= promotion.category || "Uncategorized" %>
                          </p>
                          <p class="text-xs text-gray-500 mt-1">
                            Promoted <%= promotion.age_days %> day<%= if promotion.age_days != 1, do: "s", else: "" %> ago
                          </p>
                        </div>
                        <div class="text-right">
                          <div class={
                            "inline-block px-3 py-1 rounded-full text-sm font-semibold " <>
                            "#{case promotion.status do %>
                              <%= :active -> "bg-green-100 text-green-800" %>
                              <%= :inactive -> "bg-gray-100 text-gray-800" %>
                              <%= _ -> "bg-gray-100 text-gray-800" %>
                            <% end %}"
                          }>
                            <%= if promotion.status == :active, do: "‚úÖ Active", else: "‚è∏Ô∏è Inactive" %>
                          </div>
                          <p class="text-lg font-bold text-blue-600 mt-2">
                            <%= Float.round(promotion.confidence, 3) %>
                          </p>
                          <p class="text-xs text-gray-600">Confidence</p>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>

          <!-- Effectiveness Metrics -->
          <%= if @dashboard.effectiveness_metrics && length(@dashboard.effectiveness_metrics) > 0 do %>
            <section class="mb-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Top Rules by Effectiveness</h2>
              <div class="bg-white rounded-lg shadow-md p-6">
                <div class="space-y-3">
                  <%= for rule <- Enum.take(@dashboard.effectiveness_metrics, 10) do %>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded border-l-4" style={"border-color: #{effectiveness_color(rule.effectiveness)}"}>
                      <div>
                        <p class="font-semibold text-gray-900"><%= rule.name %></p>
                        <p class="text-sm text-gray-600">
                          <%= rule.executions %> executions ‚Ä¢ <%= rule.successful %> successful
                        </p>
                      </div>
                      <div class="text-right">
                        <p class="text-lg font-bold text-green-600">
                          <%= Float.round(rule.success_rate * 100, 1) %>%
                        </p>
                        <p class="text-xs text-gray-600">Success Rate</p>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </section>
          <% end %>

          <!-- Convergence Metrics -->
          <%= if @dashboard.convergence_metrics do %>
            <section class="mb-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Convergence Analysis</h2>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                  <p class="text-sm text-gray-600 mb-2">Rules Converged</p>
                  <p class="text-3xl font-bold text-green-600">
                    <%= @dashboard.convergence_metrics.rules_converged %>
                  </p>
                  <p class="text-sm text-gray-600 mt-2">At high confidence (‚â•90%)</p>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                  <p class="text-sm text-gray-600 mb-2">Convergence Rate</p>
                  <p class="text-3xl font-bold text-blue-600">
                    <%= Float.round(@dashboard.convergence_metrics.convergence_rate * 100, 1) %>%
                  </p>
                  <p class="text-sm text-gray-600 mt-2">Of all rules</p>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                  <p class="text-sm text-gray-600 mb-2">Avg Time to High Confidence</p>
                  <p class="text-3xl font-bold text-purple-600">
                    <%= @dashboard.convergence_metrics.avg_time_to_high_confidence_days %>d
                  </p>
                  <p class="text-sm text-gray-600 mt-2">For converged rules</p>
                </div>
              </div>
            </section>
          <% end %>

          <!-- Last Updated -->
          <div class="text-sm text-gray-500 text-right">
            Last updated: <%= @dashboard.timestamp |> DateTime.truncate(:second) |> DateTime.to_string() %>
          </div>
        <% else %>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
            <p class="text-gray-600">No rule evolution data available</p>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

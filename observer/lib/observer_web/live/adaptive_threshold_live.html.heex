<div class="container mx-auto px-4 py-8">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Adaptive Confidence Gating</h1>
    <p class="text-gray-600">Self-tuning threshold for rule publishing based on real-world performance</p>
  </div>

  <div class="mb-6 flex justify-between items-center">
    <div class="flex gap-4">
      <button
        phx-click="refresh"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
      >
        ðŸ”„ Refresh
      </button>

      <button
        phx-click="reset_threshold"
        onclick="return confirm('Reset threshold to 0.85 default? This will clear learning history.')"
        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
      >
        â†» Reset to Default
      </button>
    </div>

    <div class="text-sm text-gray-500">
      Last updated: <%= if @metrics, do: format_time(@metrics[:last_adjusted_at]), else: "Loading..." %>
    </div>
  </div>

  <%= if @error do %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800 mb-6">
      <strong>Error:</strong> <%= @error %>
    </div>
  <% end %>

  <%= if @loading do %>
    <div class="text-center py-12">
      <p class="text-gray-600">Loading metrics...</p>
    </div>
  <% else %>
    <%= if @metrics && !Map.has_key?(@metrics, :error) do %>
      <!-- Status Overview -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Current Threshold</h3>
            <div class="text-3xl font-bold text-blue-600"><%= format_float(@metrics[:current_threshold]) %></div>
          </div>
          <div class="flex justify-between text-sm text-gray-600">
            <span>Min: <%= format_float(@metrics[:min_threshold]) %></span>
            <span>Max: <%= format_float(@metrics[:max_threshold]) %></span>
          </div>
          <div class="mt-4 bg-gray-200 rounded-full h-2 overflow-hidden">
            <div
              class="bg-blue-500 h-full transition-all"
              style="width: <%= ((@metrics[:current_threshold] - @metrics[:min_threshold]) / (@metrics[:max_threshold] - @metrics[:min_threshold]) * 100) %>%"
            ></div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Success Rate</h3>
            <div class="text-3xl font-bold <%= if @metrics[:actual_success_rate] >= @metrics[:target_success_rate], do: "text-green-600", else: "text-orange-600" %>">
              <%= format_percent(@metrics[:actual_success_rate]) %>
            </div>
          </div>
          <div class="text-sm text-gray-600 mb-2">Target: <%= format_percent(@metrics[:target_success_rate]) %></div>
          <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
            <div
              class="<%= success_bar_color(@metrics[:actual_success_rate]) %> h-full transition-all"
              style="width: <%= min(@metrics[:actual_success_rate] * 100, 100) %>%"
            ></div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Status</h3>
            <% {status_text, status_class} = status_badge(@metrics[:convergence_status]) %>
            <span class="px-3 py-1 rounded-full text-sm font-medium <%= status_class %>">
              <%= status_text %>
            </span>
          </div>
          <% {direction_text, direction_class} = direction_badge(@metrics[:adjustment_direction]) %>
          <div class="text-sm">
            <span class="px-2 py-1 rounded text-xs font-medium <%= direction_class %>">
              <%= direction_text %>
            </span>
          </div>
        </div>
      </div>

      <!-- Published Rules Stats -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Rule Publication Metrics</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Published Rules</span>
              <span class="text-2xl font-bold text-blue-600"><%= @metrics[:published_rules] %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Successful Rules</span>
              <span class="text-2xl font-bold text-green-600"><%= @metrics[:successful_rules] %></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Failed Rules</span>
              <span class="text-2xl font-bold text-red-600">
                <%= @metrics[:published_rules] - @metrics[:successful_rules] %>
              </span>
            </div>
            <div class="border-t pt-3 mt-3">
              <div class="text-sm text-gray-600">
                <span class="text-gray-700 font-medium"><%= @metrics[:data_points] %></span>
                /
                <span class="text-gray-700"><%= @metrics[:min_data_points_needed] %></span>
                <span class="text-gray-600">data points collected</span>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Convergence Progress</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Gap to Target</span>
              <span class="text-2xl font-bold <%= if @metrics[:gap_to_target] < 0.05, do: "text-green-600", else: "text-orange-600" %>">
                <%= format_percent(@metrics[:gap_to_target]) %>
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Converged?</span>
              <span class="text-xl font-bold">
                <%= if @metrics[:converged], do: "âœ… Yes", else: "âŒ No" %>
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-700">Iterations Remaining</span>
              <span class="text-2xl font-bold text-purple-600">
                <%= @metrics[:estimated_iterations_remaining] %>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommendation -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">Recommendation</h3>
        <p class="text-blue-800"><%= @metrics[:recommendation] %></p>
      </div>

      <!-- Detailed Info -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Detailed Information</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
          <div>
            <div class="text-gray-600">Current Threshold</div>
            <div class="text-lg font-semibold text-gray-900"><%= format_float(@metrics[:current_threshold]) %></div>
          </div>
          <div>
            <div class="text-gray-600">Target Success Rate</div>
            <div class="text-lg font-semibold text-gray-900"><%= format_percent(@metrics[:target_success_rate]) %></div>
          </div>
          <div>
            <div class="text-gray-600">Actual Success Rate</div>
            <div class="text-lg font-semibold text-gray-900"><%= format_percent(@metrics[:actual_success_rate]) %></div>
          </div>
          <div>
            <div class="text-gray-600">Adjustment Direction</div>
            <% {dir_text, dir_class} = direction_badge(@metrics[:adjustment_direction]) %>
            <div class="font-semibold <%= dir_class %> px-2 py-1 rounded text-xs mt-1 inline-block">
              <%= dir_text %>
            </div>
          </div>
          <div>
            <div class="text-gray-600">Convergence Status</div>
            <% {conv_text, conv_class} = status_badge(@metrics[:convergence_status_detail]) %>
            <div class="font-semibold <%= conv_class %> px-2 py-1 rounded text-xs mt-1 inline-block">
              <%= conv_text %>
            </div>
          </div>
          <div>
            <div class="text-gray-600">Data Points</div>
            <div class="text-lg font-semibold text-gray-900">
              <%= @metrics[:data_points] %>/<%= @metrics[:min_data_points_needed] %>
            </div>
          </div>
        </div>

        <div class="mt-6 border-t pt-4">
          <h4 class="font-semibold text-gray-800 mb-3">Bounds</h4>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="flex items-center gap-4">
              <div>
                <div class="text-gray-600">Minimum Threshold</div>
                <div class="text-lg font-semibold text-red-600"><%= format_float(@metrics[:min_threshold]) %></div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div>
                <div class="text-gray-600">Maximum Threshold</div>
                <div class="text-lg font-semibold text-green-600"><%= format_float(@metrics[:max_threshold]) %></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Help -->
      <div class="mt-8 bg-green-50 border border-green-200 rounded-lg p-6">
        <h4 class="font-semibold text-green-900 mb-2">How It Works</h4>
        <ul class="text-sm text-green-800 space-y-1">
          <li>â€¢ <strong>Starts at 0.85:</strong> Initial publishing threshold</li>
          <li>â€¢ <strong>Tracks feedback:</strong> Records which published rules succeed/fail</li>
          <li>â€¢ <strong>Measures success:</strong> Calculates actual success rate vs 90% target</li>
          <li>â€¢ <strong>Adjusts automatically:</strong> Raises/lowers threshold to maintain 90% success</li>
          <li>â€¢ <strong>Converges:</strong> Finds optimal threshold within ~30 published rules</li>
        </ul>
      </div>
    <% else %>
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-800">
        <strong>No metrics available:</strong> Adaptive gating has not been initialized yet.
      </div>
    <% end %>
  <% end %>
</div>

<style>
  .container {
    max-width: 1200px;
  }
</style>

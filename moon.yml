# https://moonrepo.dev/schemas/project.json
$schema: './.moon/cache/schemas/project.json'

type: 'application'
language: 'typescript'
project:
  name: '@singularity/workspace'
  description: 'Singularity AI development environment - polyglot monorepo'

tasks:
  # Core development tasks
  dev:
    command: 'nix develop .#dev --command just dev'
    local: true
    options:
      persistent: true

  build:
    command: 'nix develop .#dev --command just compile && nix develop .#dev --command just rust-build'
    local: true
    options:
      runInCI: true

  test:
    command: 'nix develop .#dev --command just test'
    local: true
    options:
      runInCI: true

  clean:
    command: 'nix develop .#dev --command just clean'
    local: true

  setup:
    command: 'nix develop .#dev --command just setup'
    local: true

  # Language-specific tasks
  rust:build:
    command: 'cd rust && nix develop ..#dev --command cargo build --release'
    local: true
    options:
      runInCI: true

  rust:test:
    command: 'cd rust && nix develop ..#dev --command cargo test'
    local: true
    options:
      runInCI: true

  rust:check:
    command: 'cd rust && nix develop ..#dev --command cargo check'
    local: true
    options:
      runInCI: true

  rust:service:
    command: 'cd rust && nix develop ..#dev --command cargo build --release --bin singularity-rust-service'
    local: true
    options:
      runInCI: true

  rust:start:
    command: 'cd rust && nix develop ..#dev --command cargo run --release --bin singularity-rust-service'
    local: true
    options:
      persistent: true

  # AI development tasks
  ai:lint:
    command: 'cd ai-server && nix develop ..#dev --command bunx eslint --fix src/'
    inputs:
      - 'ai-server/src/**/*.{ts,tsx,js,jsx}'
    options:
      cache: false
      runInCI: true
      local: true

  ai:test:
    command: 'cd ai-server && nix develop ..#dev --command bun test'
    local: true
    options:
      runInCI: true

  # Database tasks
  db:setup:
    command: 'cd singularity_app && nix develop ..#dev --command mix ecto.setup'
    local: true

  db:migrate:
    command: 'cd singularity_app && nix develop ..#dev --command mix ecto.migrate'
    local: true

  db:reset:
    command: 'cd singularity_app && nix develop ..#dev --command mix ecto.reset'
    local: true

  # Quality assurance
  quality:
    command: 'cd singularity_app && nix develop ..#dev --command mix quality'
    local: true
    options:
      runInCI: true

  # Analysis tasks
  analysis:rust:
    command: 'cd singularity_app && nix develop ..#dev --command mix analyze.rust'
    local: true
    options:
      runInCI: false

  analysis:query:
    command: 'cd singularity_app && nix develop ..#dev --command mix analyze.query'
    local: true
    options:
      runInCI: false

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://singularity.dev/schemas/template/v1",
  "title": "Singularity Template Schema",
  "description": "Unified schema for all Singularity templates (code patterns, quality rules, workflows)",
  "version": "1.0.0",
  "type": "object",
  "required": ["version", "type", "metadata", "content"],
  "properties": {
    "$schema": {
      "type": "string",
      "const": "https://singularity.dev/schemas/template/v1"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+(\\.\\d+)?$",
      "description": "Template version (semantic versioning)"
    },
    "type": {
      "type": "string",
      "enum": ["code_pattern", "quality_rule", "workflow", "snippet"],
      "description": "Type of template"
    },
    "metadata": {
      "type": "object",
      "required": ["id", "name", "description", "language"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique template identifier (kebab-case)"
        },
        "name": {
          "type": "string",
          "minLength": 3,
          "maxLength": 100,
          "description": "Human-readable template name"
        },
        "description": {
          "type": "string",
          "minLength": 10,
          "maxLength": 500,
          "description": "What this template does"
        },
        "language": {
          "type": "string",
          "enum": ["elixir", "erlang", "gleam", "rust", "go", "typescript", "javascript", "python", "java", "multi"],
          "description": "Primary programming language"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z0-9-]+$"
          },
          "minItems": 1,
          "maxItems": 10,
          "description": "Tags for categorization and search"
        },
        "author": {
          "type": "string",
          "default": "singularity",
          "description": "Template author"
        },
        "created": {
          "type": "string",
          "format": "date",
          "description": "Creation date (YYYY-MM-DD)"
        },
        "updated": {
          "type": "string",
          "format": "date",
          "description": "Last update date (YYYY-MM-DD)"
        },
        "embedding": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "type": "array",
              "items": {
                "type": "number"
              },
              "minItems": 1536,
              "maxItems": 1536
            }
          ],
          "description": "Qodo-Embed-1 vector (1536 dims, auto-populated)"
        }
      }
    },
    "content": {
      "type": "object",
      "required": ["code"],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 10,
          "description": "Implementation code"
        },
        "tests": {
          "type": "string",
          "description": "Test code (required for code_pattern type)"
        },
        "docs": {
          "type": "string",
          "description": "Documentation/comments"
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Required dependencies"
        },
        "examples": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Usage examples"
        }
      }
    },
    "quality": {
      "type": "object",
      "properties": {
        "rules": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "must_have_docs",
              "must_have_specs",
              "must_have_tests",
              "must_handle_errors",
              "no_code_smells",
              "follows_conventions"
            ]
          },
          "description": "Quality rules this template enforces"
        },
        "score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Quality score (0-1, minimum 0.80 for production)"
        },
        "validated": {
          "type": "boolean",
          "default": false,
          "description": "Whether template has been validated"
        }
      }
    },
    "usage": {
      "type": "object",
      "properties": {
        "count": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Number of times used in generation"
        },
        "success_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0,
          "description": "Success rate (generated code accepted/total uses)"
        },
        "last_used": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "type": "string",
              "format": "date-time"
            }
          ],
          "description": "Last usage timestamp"
        }
      }
    },
    "compatibility": {
      "type": "object",
      "properties": {
        "min_version": {
          "type": "string",
          "description": "Minimum language/framework version"
        },
        "max_version": {
          "type": "string",
          "description": "Maximum language/framework version"
        },
        "platforms": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["linux", "macos", "windows", "bsd", "all"]
          },
          "description": "Supported platforms"
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "type": {
            "const": "code_pattern"
          }
        }
      },
      "then": {
        "properties": {
          "content": {
            "required": ["code", "tests"]
          },
          "quality": {
            "required": ["score"],
            "properties": {
              "score": {
                "minimum": 0.80
              }
            }
          }
        }
      }
    }
  ]
}

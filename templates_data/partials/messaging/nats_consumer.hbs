@impl true
def handle_info({:msg, %{body: body, topic: topic, reply_to: reply_to}}, state) do
  # Process message asynchronously
  Task.Supervisor.start_child({{task_supervisor}}, fn ->
    process_message(body, topic, reply_to, state)
  end)

  {:noreply, state}
end

{{#if handle_reconnect}}
@impl true
def handle_info(:reconnect, state) do
  case connect(state) do
    {:ok, new_state} ->
      Logger.info("Reconnected to NATS")
      {:noreply, new_state}

    {:error, reason} ->
      Logger.error("Reconnection failed: #{inspect(reason)}")
      # Retry after delay
      Process.send_after(self(), :reconnect, 5_000)
      {:noreply, state}
  end
end
{{/if}}

## Private Functions

defp process_message(body, topic, reply_to, state) do
  start_time = System.monotonic_time(:millisecond)

  case decode_and_handle(body, state) do
    :ok ->
      emit_telemetry(:success, topic, start_time)
      if reply_to, do: Gnat.pub(state.conn, reply_to, "ACK")

    {:ok, response} ->
      emit_telemetry(:success, topic, start_time)
      if reply_to, do: Gnat.pub(state.conn, reply_to, response)

    {:error, reason} ->
      Logger.error("Message processing failed", topic: topic, reason: inspect(reason))
      emit_telemetry(:error, topic, start_time)
      {{#if use_dlq}}
      send_to_dlq(body, topic, reason, state)
      {{/if}}
  end
end

defp decode_and_handle(body, state) do
  case Jason.decode(body) do
    {:ok, message} ->
      state.handler.handle_message(message)

    {:error, reason} ->
      {:error, {:decode_error, reason}}
  end
end

{{#if use_dlq}}
defp send_to_dlq(body, topic, reason, state) do
  dlq_topic = "#{topic}.dlq"

  payload = Jason.encode!(%{
    original_body: body,
    error: inspect(reason),
    timestamp: DateTime.utc_now() |> DateTime.to_iso8601()
  })

  Gnat.pub(state.conn, dlq_topic, payload)
end
{{/if}}

defp emit_telemetry(status, topic, start_time) do
  duration = System.monotonic_time(:millisecond) - start_time

  :telemetry.execute(
    [:{{app_name}}, :nats_consumer, :message, status],
    %{duration_ms: duration},
    %{topic: topic}
  )
end

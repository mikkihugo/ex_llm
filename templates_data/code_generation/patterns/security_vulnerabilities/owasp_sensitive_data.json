{
  "pattern_id": "owasp_sensitive_data",
  "name": "Sensitive Data Exposure",
  "cwe": "CWE-200",
  "owasp_category": "A02:2021 - Cryptographic Failures",
  "severity": "high",
  "applicable_languages": ["python", "javascript", "java", "go", "php", "ruby", "csharp"],
  "applicable_frameworks": ["django", "flask", "express", "spring", "rails", "laravel", "aspnet"],
  "description": "Exposure of sensitive data including hardcoded secrets, unencrypted transmission, logging of PII/PHI, and insecure storage",

  "vulnerability_patterns": [
    {
      "language": "python",
      "bad_code": [
        "# Hardcoded API keys\nSTRIPE_KEY = 'sk_live_4eC39HqLyjWDarjtT1zdp7dc'\nAWS_SECRET_KEY = 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'",
        "# Logging sensitive data\nlogger.info(f'User {username} logged in with password {password}')",
        "# Unencrypted cookie\nresponse.set_cookie('session_id', user_session_id)",
        "# Sensitive data in URL\nreturn redirect(f'/reset-password?token={reset_token}&email={email}')",
        "# Plaintext storage\nwith open('credentials.txt', 'w') as f:\n    f.write(f'{username}:{password}')",
        "# Debug mode with sensitive info\napp.config['DEBUG'] = True\napp.config['SECRET_KEY'] = 'dev-secret-key-123'",
        "# Logging credit card\nprint(f'Processing payment for card: {credit_card_number}')"
      ],
      "risk_description": "Hardcoded secrets and unencrypted sensitive data lead to data breaches",
      "good_code": [
        "# Environment variables\nimport os\nfrom dotenv import load_dotenv\nload_dotenv()\n\nSTRIPE_KEY = os.getenv('STRIPE_KEY')\nif not STRIPE_KEY:\n    raise ValueError('STRIPE_KEY not configured')",
        "# Secure logging\nlogger.info(f'User {username} logged in successfully')\n# Never log passwords or sensitive data",
        "# Encrypted secure cookie\nresponse.set_cookie(\n    'session_id',\n    encrypt_session(user_session_id),\n    secure=True,\n    httponly=True,\n    samesite='Strict'\n)",
        "# POST request for sensitive data\n# Use form POST instead of GET with sensitive data\n@app.route('/reset-password', methods=['POST'])\ndef reset_password():\n    token = request.form.get('token')",
        "# Encrypted storage\nfrom cryptography.fernet import Fernet\nkey = Fernet.generate_key()\nfernet = Fernet(key)\nencrypted_data = fernet.encrypt(sensitive_data.encode())",
        "# Production config\napp.config['DEBUG'] = False\napp.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\nassert app.config['SECRET_KEY'], 'SECRET_KEY must be set'"
      ],
      "fix_explanation": "Use environment variables for secrets, encrypt sensitive data, secure logging practices"
    },
    {
      "language": "javascript",
      "bad_code": [
        "// Hardcoded API keys\nconst API_KEY = 'AIzaSyDaGmWKa4JsXZ-HjGw7ISLn_3namBGewQe';\nconst DB_PASSWORD = 'admin123';",
        "// Logging passwords\nconsole.log(`User ${email} attempted login with password: ${password}`);",
        "// Sensitive data in localStorage\nlocalStorage.setItem('creditCard', creditCardNumber);\nlocalStorage.setItem('ssn', socialSecurityNumber);",
        "// Unencrypted transmission\nfetch('http://api.example.com/user', {\n    body: JSON.stringify({ password, ssn })\n});",
        "// Sensitive data in URL\nwindow.location = `/verify?email=${email}&code=${verificationCode}`;",
        "// Client-side secrets\nconst encryptionKey = 'my-secret-key-123';",
        "// Logging tokens\nconsole.log('Auth token:', authToken);"
      ],
      "risk_description": "Client-side secrets and unencrypted data storage expose sensitive information",
      "good_code": [
        "// Environment variables (server-side)\nrequire('dotenv').config();\nconst API_KEY = process.env.API_KEY;\nif (!API_KEY) {\n    throw new Error('API_KEY not configured');\n}",
        "// Secure logging\nconsole.log(`User ${email} attempted login`);\n// Never log passwords",
        "// Use secure session storage\n// Don't store sensitive data client-side\n// Use server-side sessions instead",
        "// HTTPS only\nfetch('https://api.example.com/user', {\n    method: 'POST',\n    headers: {\n        'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({ /* non-sensitive data */ })\n});",
        "// POST for sensitive data\nfetch('/verify', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ email, code: verificationCode })\n});",
        "// Server-side encryption\n// Never handle encryption keys client-side\nconst crypto = require('crypto');\nconst algorithm = 'aes-256-gcm';\nconst encrypt = (text) => {\n    const key = Buffer.from(process.env.ENCRYPTION_KEY, 'hex');\n    const iv = crypto.randomBytes(16);\n    const cipher = crypto.createCipheriv(algorithm, key, iv);\n    // ... encryption logic\n};"
      ],
      "fix_explanation": "Keep secrets server-side, use HTTPS, avoid client-side storage of sensitive data"
    },
    {
      "language": "java",
      "bad_code": [
        "// Hardcoded database password\nprivate static final String DB_PASSWORD = \"root123\";\nString url = \"jdbc:mysql://localhost:3306/db?password=\" + DB_PASSWORD;",
        "// Logging sensitive data\nlogger.info(\"Credit card payment: \" + creditCardNumber);\nlogger.debug(\"User password: \" + password);",
        "// Sensitive data in exception\nthrow new Exception(\"Login failed for user: \" + username + \" with password: \" + password);",
        "// Unencrypted properties file\nProperties props = new Properties();\nprops.setProperty(\"api.key\", \"sk_live_1234567890\");\nprops.store(new FileOutputStream(\"config.properties\"), null);",
        "// Sensitive data in URL\nresponse.sendRedirect(\"/verify?token=\" + resetToken + \"&email=\" + email);",
        "// Plaintext file storage\nFileWriter fw = new FileWriter(\"users.txt\");\nfw.write(username + \":\" + password);",
        "// Debug with sensitive info\nSystem.out.println(\"SSN: \" + socialSecurityNumber);"
      ],
      "risk_description": "Hardcoded credentials and plaintext storage compromise data security",
      "good_code": [
        "// Environment variables\nString dbPassword = System.getenv(\"DB_PASSWORD\");\nif (dbPassword == null) {\n    throw new IllegalStateException(\"DB_PASSWORD not set\");\n}\n\n// Or use properties file\nProperties props = new Properties();\ntry (InputStream input = new FileInputStream(\"secure.properties\")) {\n    props.load(input);\n    String apiKey = props.getProperty(\"api.key\");\n}",
        "// Secure logging\nlogger.info(\"Payment processed for user: {}\", userId);\n// Use structured logging with filtering\nlogger.debug(\"Login attempt for user: {}\", username);",
        "// Sanitized exceptions\nthrow new AuthenticationException(\"Invalid credentials for user: \" + username);\n// Never include passwords in exceptions",
        "// Encrypted properties\nimport javax.crypto.Cipher;\nimport javax.crypto.spec.SecretKeySpec;\n\npublic String encryptProperty(String value) {\n    Key key = new SecretKeySpec(getKey(), \"AES\");\n    Cipher cipher = Cipher.getInstance(\"AES\");\n    cipher.init(Cipher.ENCRYPT_MODE, key);\n    return Base64.getEncoder().encodeToString(cipher.doFinal(value.getBytes()));\n}",
        "// POST for sensitive data\n@PostMapping(\"/verify\")\npublic String verify(@RequestParam String token, @RequestParam String email) {\n    // Handle in POST body, not URL\n}",
        "// Use Java KeyStore\nKeyStore keyStore = KeyStore.getInstance(\"JCEKS\");\nkeyStore.load(new FileInputStream(\"keystore.jks\"), keystorePassword);\nKey key = keyStore.getKey(\"apikey\", keyPassword);"
      ],
      "fix_explanation": "Use environment variables, KeyStore for secrets, encrypt sensitive data at rest"
    },
    {
      "language": "go",
      "bad_code": [
        "// Hardcoded API key\nconst APIKey = \"sk_live_1234567890abcdef\"\nconst DBPassword = \"admin123\"",
        "// Logging sensitive data\nlog.Printf(\"User %s logged in with password %s\", username, password)\nfmt.Println(\"Credit card:\", creditCardNumber)",
        "// Sensitive data in error\nreturn fmt.Errorf(\"authentication failed for %s with password %s\", user, pass)",
        "// Unencrypted file\ndata := fmt.Sprintf(\"%s:%s\", username, password)\nioutil.WriteFile(\"credentials.txt\", []byte(data), 0644)",
        "// Sensitive in URL\nhttp.Redirect(w, r, fmt.Sprintf(\"/reset?token=%s&email=%s\", token, email), 302)",
        "// Plaintext config\nconfig := map[string]string{\n    \"api_key\": \"sk_test_1234567890\",\n    \"db_password\": \"root123\",\n}"
      ],
      "risk_description": "Exposed secrets and unencrypted sensitive data create security vulnerabilities",
      "good_code": [
        "// Environment variables\nimport \"os\"\n\napiKey := os.Getenv(\"API_KEY\")\nif apiKey == \"\" {\n    log.Fatal(\"API_KEY not set\")\n}\n\n// Using viper for config\nimport \"github.com/spf13/viper\"\nviper.SetConfigFile(\".env\")\nviper.ReadInConfig()\napiKey := viper.GetString(\"API_KEY\")",
        "// Secure logging\nlog.Printf(\"User %s logged in successfully\", username)\n// Never log passwords or sensitive data\n\n// Structured logging with zap\nlogger.Info(\"user login\",\n    zap.String(\"username\", username),\n    // Don't log password\n)",
        "// Sanitized errors\nreturn fmt.Errorf(\"authentication failed for user %s\", user)\n// Never include passwords in errors",
        "// Encrypted storage\nimport \"crypto/aes\"\nimport \"crypto/cipher\"\n\nfunc encrypt(plaintext []byte, key []byte) ([]byte, error) {\n    block, err := aes.NewCipher(key)\n    if err != nil {\n        return nil, err\n    }\n    gcm, err := cipher.NewGCM(block)\n    if err != nil {\n        return nil, err\n    }\n    nonce := make([]byte, gcm.NonceSize())\n    if _, err := io.ReadFull(rand.Reader, nonce); err != nil {\n        return nil, err\n    }\n    return gcm.Seal(nonce, nonce, plaintext, nil), nil\n}",
        "// POST for sensitive data\nfunc resetHandler(w http.ResponseWriter, r *http.Request) {\n    if r.Method != \"POST\" {\n        http.Error(w, \"Method not allowed\", 405)\n        return\n    }\n    token := r.FormValue(\"token\")\n    email := r.FormValue(\"email\")\n    // Process in POST body\n}"
      ],
      "fix_explanation": "Use environment variables, encrypt sensitive data, implement secure logging"
    },
    {
      "language": "php",
      "bad_code": [
        "// Hardcoded credentials\n$api_key = 'sk_live_1234567890abcdef';\n$db_password = 'root123';",
        "// Logging sensitive data\nerror_log(\"User $email logged in with password: $password\");\necho \"Credit card: $creditCardNumber\";",
        "// Sensitive in URL\nheader(\"Location: /reset?token=$token&email=$email\");",
        "// Unencrypted cookie\nsetcookie('user_data', serialize($userData));",
        "// Plaintext file\nfile_put_contents('passwords.txt', \"$username:$password\");",
        "// Debug with sensitive data\nvar_dump($_POST); // Contains passwords\nprint_r($creditCardData);",
        "// Config file with secrets\n$config = [\n    'stripe_key' => 'sk_test_123',\n    'db_pass' => 'admin123'\n];"
      ],
      "risk_description": "Hardcoded secrets and plaintext storage expose sensitive information",
      "good_code": [
        "// Environment variables\n$api_key = $_ENV['API_KEY'] ?? getenv('API_KEY');\nif (!$api_key) {\n    throw new Exception('API_KEY not configured');\n}\n\n// Using .env file\n$dotenv = Dotenv\\Dotenv::createImmutable(__DIR__);\n$dotenv->load();\n$api_key = $_ENV['API_KEY'];",
        "// Secure logging\nerror_log(\"User $email logged in successfully\");\n// Never log passwords or sensitive data\n\n// Use monolog with filtering\nuse Monolog\\Logger;\n$logger = new Logger('app');\n$logger->info('User login', ['user' => $email]);",
        "// POST for sensitive data\n// In form:\n<form method=\"POST\" action=\"/reset\">\n    <input type=\"hidden\" name=\"token\" value=\"<?= htmlspecialchars($token) ?>\">\n    <input type=\"hidden\" name=\"email\" value=\"<?= htmlspecialchars($email) ?>\">\n</form>",
        "// Encrypted cookie\n$encrypted = openssl_encrypt(\n    serialize($userData),\n    'AES-256-GCM',\n    $key,\n    0,\n    $iv,\n    $tag\n);\nsetcookie('user_data', $encrypted, [\n    'secure' => true,\n    'httponly' => true,\n    'samesite' => 'Strict'\n]);",
        "// Encrypted file storage\n$encrypted = openssl_encrypt(\n    $sensitiveData,\n    'AES-256-CBC',\n    $encryption_key,\n    0,\n    $iv\n);\nfile_put_contents('data.enc', $encrypted);",
        "// Secure config\n// config.php (outside web root)\nreturn [\n    'api_key' => getenv('API_KEY'),\n    'db_pass' => getenv('DB_PASSWORD')\n];"
      ],
      "fix_explanation": "Use environment variables, encrypt sensitive data, secure cookie flags"
    },
    {
      "language": "ruby",
      "bad_code": [
        "# Hardcoded secrets\nAPI_KEY = 'sk_live_1234567890'\nDATABASE_PASSWORD = 'admin123'",
        "# Logging sensitive data\nRails.logger.info \"User #{email} logged in with password: #{password}\"\nputs \"Processing card: #{credit_card_number}\"",
        "# Sensitive in URL\nredirect_to \"/verify?token=#{token}&email=#{email}\"",
        "# Unencrypted storage\nFile.write('passwords.txt', \"#{username}:#{password}\")",
        "# Debug with sensitive data\np params # May contain passwords\nputs user.attributes # Includes password_digest",
        "# Config with secrets\nconfig = {\n  stripe_key: 'sk_test_123',\n  secret_key: 'my-secret-key'\n}"
      ],
      "risk_description": "Hardcoded credentials and plaintext logging compromise security",
      "good_code": [
        "# Rails credentials\nRails.application.credentials.api_key\n# Or environment variables\nENV['API_KEY'] || Rails.application.credentials.api_key",
        "# Secure logging\nRails.logger.info \"User #{email} logged in successfully\"\n# Filter parameters in Rails\nconfig.filter_parameters += [:password, :credit_card]",
        "# POST for sensitive data\n# Use form helpers\n<%= form_with url: verify_path, method: :post do |form| %>\n  <%= form.hidden_field :token, value: token %>\n  <%= form.hidden_field :email, value: email %>\n<% end %>",
        "# Encrypted attributes (Rails 7+)\nclass User < ApplicationRecord\n  encrypts :ssn, :credit_card_number\nend\n\n# Or manual encryption\nrequire 'openssl'\ncipher = OpenSSL::Cipher.new('AES-256-GCM')\ncipher.encrypt\ncipher.key = key\niv = cipher.random_iv\nencrypted = cipher.update(data) + cipher.final",
        "# Using Rails secrets\n# config/secrets.yml\nproduction:\n  secret_key_base: <%= ENV[\"SECRET_KEY_BASE\"] %>\n  api_key: <%= ENV[\"API_KEY\"] %>",
        "# Secure cookies\ncookies.encrypted[:user_data] = {\n  value: user_data,\n  secure: true,\n  httponly: true,\n  same_site: :strict\n}"
      ],
      "fix_explanation": "Use Rails credentials, encrypted attributes, filter sensitive parameters"
    },
    {
      "language": "csharp",
      "bad_code": [
        "// Hardcoded secrets\nconst string ApiKey = \"sk_live_1234567890\";\nconst string DbPassword = \"admin123\";",
        "// Logging sensitive data\nlogger.LogInformation($\"User {email} logged in with password {password}\");\nConsole.WriteLine($\"Credit card: {creditCardNumber}\");",
        "// Sensitive in URL\nreturn Redirect($\"/verify?token={token}&email={email}\");",
        "// Plaintext storage\nFile.WriteAllText(\"passwords.txt\", $\"{username}:{password}\");",
        "// Web.config with secrets\n<appSettings>\n  <add key=\"ApiKey\" value=\"sk_test_123\" />\n  <add key=\"DbPassword\" value=\"admin123\" />\n</appSettings>",
        "// Debug with sensitive data\nDebug.WriteLine($\"SSN: {socialSecurityNumber}\");\nTrace.WriteLine($\"Password: {password}\");",
        "// Unencrypted connection string\nstring connString = $\"Server=localhost;Database=myDB;User Id=sa;Password={password}\";"
      ],
      "risk_description": "Hardcoded secrets and plaintext storage create security vulnerabilities",
      "good_code": [
        "// User Secrets (development)\n// dotnet user-secrets set \"ApiKey\" \"value\"\nvar apiKey = Configuration[\"ApiKey\"];\n\n// Azure Key Vault (production)\nvar keyVaultUrl = new Uri($\"https://{vaultName}.vault.azure.net/\");\nvar credential = new DefaultAzureCredential();\nvar client = new SecretClient(keyVaultUrl, credential);\nKeyVaultSecret secret = await client.GetSecretAsync(\"ApiKey\");",
        "// Secure logging\nlogger.LogInformation(\"User {Email} logged in successfully\", email);\n// Configure log filtering\nlogging.AddFilter(\"Microsoft\", LogLevel.Warning)\n       .AddFilter((category, level) => !category.Contains(\"Sensitive\"));",
        "// POST for sensitive data\n[HttpPost]\npublic IActionResult Verify(string token, string email)\n{\n    // Handle in POST body, not query string\n    return View();\n}",
        "// Data Protection API\nusing Microsoft.AspNetCore.DataProtection;\n\nvar protector = dataProtectionProvider.CreateProtector(\"purpose\");\nstring encrypted = protector.Protect(sensitiveData);\nstring decrypted = protector.Unprotect(encrypted);",
        "// Protected configuration\nConfiguration config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);\nConfigurationSection section = config.GetSection(\"connectionStrings\");\nif (!section.SectionInformation.IsProtected)\n{\n    section.SectionInformation.ProtectSection(\"DataProtectionConfigurationProvider\");\n    config.Save();\n}",
        "// Secure connection string\nvar builder = new SqlConnectionStringBuilder\n{\n    DataSource = \"server\",\n    InitialCatalog = \"database\",\n    IntegratedSecurity = true, // Windows auth\n    Encrypt = true\n};"
      ],
      "fix_explanation": "Use User Secrets, Azure Key Vault, Data Protection API for encryption"
    }
  ],

  "detection_rules": {
    "ast_patterns": [
      "Hardcoded string literals containing 'key', 'password', 'secret', 'token'",
      "Logging statements with password variables",
      "URL construction with sensitive parameters",
      "File writes with credentials",
      "localStorage/sessionStorage with sensitive data",
      "Console/print statements with sensitive variables"
    ],
    "regex_patterns": [
      "['\"]sk_live_[a-zA-Z0-9]+['\"]",
      "['\"]AKIA[A-Z0-9]{16}['\"]",
      "password\\s*[:=]\\s*['\"][^'\"]+['\"]",
      "api[_-]?key\\s*[:=]\\s*['\"][^'\"]+['\"]",
      "console\\.log.*password",
      "logger\\..*password",
      "localStorage\\.setItem.*['\"]token['\"]"
    ],
    "code_smell_indicators": [
      "Credentials in source files",
      "HTTP instead of HTTPS",
      "Missing encryption for sensitive data",
      "Sensitive data in URLs",
      "Debug mode in production",
      "Verbose error messages with data"
    ]
  },

  "remediation": {
    "steps": [
      "Move all secrets to environment variables or secure vaults",
      "Implement encryption for data at rest and in transit",
      "Use HTTPS/TLS for all communications",
      "Implement secure logging practices - never log sensitive data",
      "Use POST requests for sensitive data, not GET",
      "Encrypt cookies and set secure flags",
      "Implement key rotation policies",
      "Use dedicated secrets management tools",
      "Mask sensitive data in UI displays",
      "Implement data classification and handling policies"
    ],
    "code_examples": [
      {
        "framework": "AWS Secrets Manager",
        "safe_code": "import boto3\nimport json\n\ndef get_secret(secret_name):\n    client = boto3.client('secretsmanager')\n    response = client.get_secret_value(SecretId=secret_name)\n    return json.loads(response['SecretString'])\n\nsecrets = get_secret('prod/myapp/secrets')\napi_key = secrets['api_key']"
      },
      {
        "framework": "HashiCorp Vault",
        "safe_code": "import hvac\n\nclient = hvac.Client(url='https://vault.example.com')\nclient.token = os.environ['VAULT_TOKEN']\n\nresponse = client.secrets.kv.v2.read_secret_version(\n    path='myapp/config'\n)\napi_key = response['data']['data']['api_key']"
      }
    ],
    "prevention_guidelines": [
      "Never commit secrets to version control",
      "Use .gitignore for environment files",
      "Implement secret scanning in CI/CD",
      "Regular rotation of credentials",
      "Audit access to sensitive data",
      "Implement data loss prevention (DLP) tools",
      "Train developers on secure coding practices",
      "Use infrastructure as code for secrets management"
    ]
  },

  "impact": {
    "severity_score": 8.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:L/A:N",
    "business_impact": "Data breach, regulatory fines, reputation damage, identity theft",
    "technical_impact": "Unauthorized access, data theft, account takeover, system compromise",
    "confidentiality": "high",
    "integrity": "medium",
    "availability": "low",
    "compliance_violations": ["GDPR", "PCI-DSS", "HIPAA", "CCPA", "SOC2"]
  },

  "references": [
    "https://owasp.org/Top10/A02_2021-Cryptographic_Failures/",
    "https://cwe.mitre.org/data/definitions/200.html",
    "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html",
    "https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html",
    "https://12factor.net/config"
  ],

  "test_cases": [
    {
      "input": "const API_KEY = 'sk_live_abc123'",
      "description": "Hardcoded API key",
      "expected_detection": true,
      "attack_type": "hardcoded_secret"
    },
    {
      "input": "logger.info('Password: ' + password)",
      "description": "Logging sensitive data",
      "expected_detection": true,
      "attack_type": "sensitive_logging"
    },
    {
      "input": "http://api.example.com/data",
      "description": "Unencrypted transmission",
      "expected_detection": true,
      "attack_type": "plaintext_transmission"
    }
  ],

  "metadata": {
    "last_updated": "2025-01-10",
    "version": "1.0.0",
    "tags": ["data-exposure", "secrets", "encryption", "high"],
    "related_patterns": ["cwe_312_cleartext_storage", "cwe_319_cleartext_transmission", "cwe_798_hardcoded_credentials"]
  }
}
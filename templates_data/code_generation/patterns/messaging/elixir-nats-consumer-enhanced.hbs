defmodule {{module_name}} do
  {{> base/moduledoc_production}}

  {{> otp/genserver_skeleton
    state_fields=[
      {name: "conn", type: "Gnat.t() | nil", default: "nil"},
      {name: "subscription", type: "reference() | nil", default: "nil"},
      {name: "subject", type: "String.t()", default: "opts[:subject]"},
      {name: "handler", type: "module()", default: "opts[:handler]"}
    ]
    use_via_tuple=false
    async_init=true
  }}

  {{> messaging/nats_consumer
    task_supervisor="MyApp.TaskSupervisor"
    handle_reconnect=true
    use_dlq=true
    app_name=app_name
  }}

  defp connect(state) do
    with {:ok, conn} <- Gnat.start_link(),
         {:ok, sub} <- Gnat.sub(conn, self(), state.subject) do
      {:ok, %{state | conn: conn, subscription: sub}}
    end
  end

  {{> base/telemetry
    app_name=app_name
    module_type="nats_consumer"
    include_timing=true
    include_error_tracking=true
  }}
end

# https://moonrepo.dev/schemas/project.json
$schema: '../../.moon/cache/schemas/project.json'

type: 'library'
language: 'rust'
project:
  name: '@singularity/prompt_engine'
  description: 'Rust NIF for dynamic prompt generation and optimization'
  channel: '#internal'
  owner: 'singularity'
  maintainers: ['mikkihugo']

tasks:
  # Rust cargo tasks
  cargo:build:
    command: 'cargo build --release'
    inputs:
      - 'src/**/*.rs'
      - 'Cargo.toml'
    outputs:
      - 'target/release/'
    options:
      cache: true
      runInCI: true

  cargo:test:
    command: 'cargo test --release'
    deps:
      - 'cargo:build'
    inputs:
      - 'src/**/*.rs'
      - 'tests/**/*.rs'
      - 'Cargo.toml'
    options:
      cache: true
      runInCI: true

  cargo:check:
    command: 'cargo check'
    inputs:
      - 'src/**/*.rs'
      - 'Cargo.toml'
    options:
      cache: true
      runInCI: true

  cargo:clippy:
    command: 'cargo clippy --all-targets --all-features -- -D warnings'
    deps:
      - 'cargo:check'
    options:
      cache: true
      runInCI: true

  # Elixir NIF wrapper - compilable as standalone package
  mix:deps:
    command: 'mix deps.get'
    inputs:
      - 'mix.exs'
      - 'mix.lock'
    outputs:
      - 'deps/'

  mix:compile:
    command: 'mix compile'
    deps:
      - 'mix:deps'
      - 'cargo:build'
    inputs:
      - 'lib/**/*.ex'
      - 'mix.exs'
      - 'src/**/*.rs'
    outputs:
      - '_build/'
    options:
      cache: true

  mix:test:
    command: 'mix test'
    deps:
      - 'mix:compile'
    inputs:
      - 'test/**/*.{ex,exs}'
      - 'lib/**/*.ex'
    options:
      runInCI: true

  # Documentation
  docs:
    command: 'mix docs'
    deps:
      - 'mix:compile'
    outputs:
      - 'doc/'

# This package is internally used by Singularity
# Can be published to internal registry (hex.pm private) or crates.io

dotenv_if_exists .env
dotenv_if_exists .envrc.local
use flake

# Standard defaults (override by setting the variable before entering direnv)
export NIXPKGS_ALLOW_UNFREE="${NIXPKGS_ALLOW_UNFREE:-1}"

if [ -z "${NIX_BUILD_CORES:-}" ]; then
        export NIX_BUILD_CORES="$(nproc)"
fi

export MIX_ENV="${MIX_ENV:-dev}"

STATE_DIR="${STATE_DIR:-$HOME/.local/share/singularity}"
export STATE_DIR
export MIX_HOME="${MIX_HOME:-$STATE_DIR/.mix}"
export HEX_HOME="${HEX_HOME:-$STATE_DIR/.hex}"

# Auto-expose Google ADC credentials for Gemini providers if available locally
ADC_FILE="$HOME/.config/gcloud/application_default_credentials.json"
if [ -f "$ADC_FILE" ]; then
        export GOOGLE_APPLICATION_CREDENTIALS="$ADC_FILE"

        if [ -z "${GOOGLE_APPLICATION_CREDENTIALS_JSON:-}" ]; then
                export GOOGLE_APPLICATION_CREDENTIALS_JSON="$(python3 - "$ADC_FILE" <<'PY'
import base64
import pathlib
import sys

path = pathlib.Path(sys.argv[1])
sys.stdout.write(base64.b64encode(path.read_bytes()).decode('ascii'))
PY
)"
        fi
fi

DEFAULT_GEMINI_PROJECT="gemini-code-473918"
if [ -z "${GEMINI_CODE_PROJECT:-}" ]; then
        export GEMINI_CODE_PROJECT="$DEFAULT_GEMINI_PROJECT"
fi

if [ -z "${GOOGLE_CLOUD_PROJECT:-}" ]; then
        export GOOGLE_CLOUD_PROJECT="$GEMINI_CODE_PROJECT"
fi

if [ -z "${CLOUDSDK_CORE_PROJECT:-}" ]; then
        export CLOUDSDK_CORE_PROJECT="$GEMINI_CODE_PROJECT"
fi

# Ensure Moonrepo CLI uses C.UTF-8 locale globally
export LC_ALL=C.UTF-8
export LANG=C.UTF-8

# Singularity Unified Build Cache Configuration
# Shared cache directories for ALL build systems coordinated by moonrepo

# === RUST/CARGO DEPENDENCY & BUILD CACHING ===
# Shared cargo dependencies across all projects (crates.io downloads)
export CARGO_HOME="${HOME}/.cache/singularity/cargo"

# sccache for distributed Rust compilation caching
export SCCACHE_DIR="${HOME}/.cache/singularity/sccache"
export SCCACHE_CACHE_SIZE="10G"

# Cargo build artifacts (local per-project for isolation, but deps are shared via CARGO_HOME)
export CARGO_TARGET_DIR=".cargo-build"
export CARGO_INCREMENTAL="0"  # Disabled for sccache compatibility

# === BUN DEPENDENCY & BUILD CACHING ===
# Shared bun dependencies across all projects (npm packages)
export BUN_INSTALL_CACHE_DIR="${BUN_INSTALL_CACHE_DIR:-$STATE_DIR/.bun-cache}"
export BUN_INSTALL_GLOBAL_DIR="${BUN_INSTALL_GLOBAL_DIR:-$STATE_DIR/.bun-global}"

# === NODE.JS/NPM CACHING (if fallback from bun) ===
export npm_config_cache="${HOME}/.cache/singularity/npm"

# === MOON CACHING ===
# Moon's workspace cache (task outputs, hashes)
export MOON_CACHE="${PWD}/.moon/cache"

# === TYPESCRIPT CACHING ===
# TypeScript build info cache
export TSC_CACHE_DIR="${HOME}/.cache/singularity/tsc"

# === PROTO TOOLCHAIN CACHING ===
# Proto tools (already uses ~/.proto, but explicit for clarity)
export PROTO_HOME="${HOME}/.proto"

# === BUILD PARALLELISM ===
# Unified parallel build jobs across all systems (6 cores)
NPROC=$(nproc)
export CARGO_BUILD_JOBS="${NPROC}"
export BUN_INSTALL_PARALLELISM="${NPROC}"

# === PERFORMANCE OPTIMIZATIONS ===
# Enable modern cargo sparse index (faster dependency resolution)
export CARGO_REGISTRIES_CRATES_IO_PROTOCOL="sparse"

# === RUST LINKER CONFIGURATION ===
# Use mold linker for fast Rust compilation
export RUSTFLAGS="-C linker=gcc -C link-arg=-fuse-ld=mold"

# Add sccache to PATH (from Nix)
export PATH="/nix/store/dhlqnjaqhg3sqcwsy2avw7rvbawgikaz-sccache-0.10.0/bin:$PATH"

# Create cache directories if they don't exist (quietly)
mkdir -p "${CARGO_HOME}" "${SCCACHE_DIR}" "${BUN_INSTALL_CACHE_DIR}" "${BUN_INSTALL_GLOBAL_DIR}" "${npm_config_cache}" "${TSC_CACHE_DIR}" 2>/dev/null || true

# Optional silent mode: export SINGULARITY_ENVRC_SILENT=1 to suppress banner
if [ -z "${SINGULARITY_ENVRC_SILENT}" ]; then
        echo "[OK] Singularity unified caching enabled:"
        echo "  Rust deps: ${CARGO_HOME}"
        echo "  Rust builds: sccache (${SCCACHE_DIR}, ${SCCACHE_CACHE_SIZE})"
        echo "  Bun deps: ${BUN_INSTALL_CACHE_DIR}"
        echo "  Moon tasks: ${MOON_CACHE}"
        echo "  Parallel: ${NPROC} cores"
fi

# Provide a helper to quickly silence in current shell: `export SINGULARITY_ENVRC_SILENT=1` then reload.

# === CACHIX BINARY CACHE ===
# Pull from public cache; no token required. For pushes, add CACHIX_AUTH_TOKEN in .envrc.local.
# export CACHIX_AUTH_TOKEN="your-token-here"  # optional, only for pushing
if command -v cachix >/dev/null 2>&1; then
  cachix use mikkihugo >/dev/null 2>&1 || true
else
  # Fallback: inject substituter so nix develop pulls from the cache
  export NIX_CONFIG="${NIX_CONFIG}\nextra-substituters = https://mikkihugo.cachix.org\nextra-trusted-public-keys = mikkihugo.cachix.org-1:dxqCDAvMSMefAFwSnXYvUdPnHJYq+pqF8tul8bih9Po="
fi

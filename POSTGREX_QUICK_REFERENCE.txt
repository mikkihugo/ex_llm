================================================================================
POSTGREX.QUERY!() - QUICK REFERENCE TABLE
================================================================================

SOURCE FILE: singularity/lib/singularity/search/code_search.ex
TOTAL CALLS: 48 | FILE SIZE: 1,273 lines

================================================================================
ALL 48 POSTGREX.QUERY!() CALLS - INDEXED BY LINE NUMBER
================================================================================

Line | Function                          | Type   | Operation                  | Params
-----|--------------------------------------|--------|----------------------------|---------
 58  | create_codebase_metadata_table     | DDL    | CREATE TABLE codebase_metadata | 0
 160 | create_codebase_metadata_table     | DDL    | CREATE TABLE codebase_registry | 0
 184 | create_graph_tables                | DDL    | CREATE TABLE graph_nodes       | 0
 207 | create_graph_tables                | DDL    | CREATE TABLE graph_edges       | 0
 230 | create_graph_tables                | DDL    | CREATE TABLE graph_types       | 0
 244 | create_graph_tables                | DML    | INSERT INTO graph_types        | 0
 260 | create_vector_search_tables        | DDL    | CREATE TABLE vector_search     | 0
 280 | create_vector_search_tables        | DDL    | CREATE TABLE vector_similarity_cache | 0
 300 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_codebase_id | 0
 309 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_codebase_path | 0
 319 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_registry_codebase_id | 0
 328 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_registry_codebase_path | 0
 337 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_registry_analysis_status | 0
 346 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_path | 0
 355 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_language | 0
 364 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_file_type | 0
 373 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_quality_score | 0
 382 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_complexity | 0
 391 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_pagerank | 0
 401 | create_performance_indexes        | DDL    | CREATE INDEX idx_codebase_metadata_vector (ivfflat) | 0
 411 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_nodes_codebase_id | 0
 420 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_nodes_node_id | 0
 429 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_nodes_node_type | 0
 438 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_nodes_file_path | 0
 447 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_edges_codebase_id | 0
 456 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_edges_from_node | 0
 465 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_edges_to_node | 0
 474 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_edges_edge_type | 0
 484 | create_performance_indexes        | DDL    | CREATE INDEX idx_graph_nodes_vector (ivfflat) | 0
 494 | create_performance_indexes        | DDL    | CREATE INDEX idx_vector_search_codebase_id | 0
 503 | create_performance_indexes        | DDL    | CREATE INDEX idx_vector_search_file_path | 0
 512 | create_performance_indexes        | DDL    | CREATE INDEX idx_vector_search_content_type | 0
 521 | create_performance_indexes        | DDL    | CREATE INDEX idx_vector_search_vector (ivfflat) | 0
 534 | create_apache_age_extension       | DDL    | CREATE EXTENSION age           | 0
 560 | register_codebase                  | DML    | INSERT INTO codebase_registry  | 7
 592 | get_codebase_registry              | Query  | SELECT codebase_registry       | 1
 644 | list_codebases                     | Query  | SELECT * FROM codebase_registry | 0
 690 | update_codebase_status             | DML    | UPDATE codebase_registry       | 3
 708 | insert_codebase_metadata           | DML    | INSERT INTO codebase_metadata  | 55 (!!!)
 859 | insert_graph_node                  | DML    | INSERT INTO graph_nodes        | 9
 893 | insert_graph_edge                  | DML    | INSERT INTO graph_edges        | 7
 961 | semantic_search [FALLBACK]         | Query  | SELECT with vector <->         | 3
 990 | find_similar_nodes                 | Query  | SELECT with CTE               | 3
1047 | multi_codebase_search              | Query  | SELECT with dynamic IN         | N+2
1093 | get_dependencies                   | Query  | SELECT with JOIN               | 1
1127 | get_dependents                     | Query  | SELECT with JOIN               | 1
1161 | detect_circular_dependencies       | Query  | SELECT with RECURSIVE CTE      | 0
1223 | calculate_pagerank                 | Query  | SELECT with RECURSIVE CTE      | 2

================================================================================
SUMMARY BY OPERATION TYPE
================================================================================

DDL OPERATIONS: 33 calls (69%)
├─ Table Creation: 8 calls
│  ├─ Lines 58, 160, 184, 207, 230, 260, 280, 534
│  └─ Tables: codebase_metadata, codebase_registry, graph_nodes, graph_edges,
│             graph_types, vector_search, vector_similarity_cache, apache age
│
└─ Index Creation: 25 calls
   ├─ Lines 300-309, 319-344, 346-398, 401-528
   └─ Indexes: 25 different indexes on 4 tables

DML OPERATIONS: 6 calls (13%)
├─ INSERT: 5 calls
│  ├─ Lines 560, 708, 859, 893, 244
│  └─ Tables: codebase_registry, codebase_metadata, graph_nodes, graph_edges
│
└─ UPDATE: 1 call
   ├─ Line 690
   └─ Table: codebase_registry

QUERY OPERATIONS: 9 calls (18%)
├─ Simple/Medium (4 calls)
│  ├─ Lines 592, 644, 1093, 1127
│  └─ Operations: SELECT WHERE, SELECT ORDER BY, SELECT with JOIN
│
└─ Complex (5 calls)
   ├─ Lines 961, 990, 1047, 1161, 1223
   └─ Features: Vector distance (<->), CTE, RECURSIVE CTE, Dynamic SQL

================================================================================
COMPLEXITY CLASSIFICATION
================================================================================

SIMPLE (5 calls, 10%)
  - Line 644: list_codebases - SELECT ORDER BY
  - Line 244: create_graph_tables - INSERT defaults
  - Line 534: create_apache_age_extension - CREATE EXTENSION
  - Line 161: create_codebase_metadata_table - CREATE TABLE codebase_registry
  - Line 160: create_codebase_metadata_table - CREATE TABLE codebase_registry

MEDIUM (25 calls, 52%)
  - All other table/index creation calls
  - get_codebase_registry (line 592)
  - register_codebase (line 560)
  - update_codebase_status (line 690)
  - get_dependencies (line 1093)
  - get_dependents (line 1127)

COMPLEX (18 calls, 37%)
  - semantic_search (line 961) - Vector similarity
  - find_similar_nodes (line 990) - CTE + CROSS JOIN
  - multi_codebase_search (line 1047) - Dynamic WHERE IN
  - detect_circular_dependencies (line 1161) - RECURSIVE CTE
  - calculate_pagerank (line 1223) - RECURSIVE CTE
  - insert_codebase_metadata (line 708) - 55 parameters!

================================================================================
CONVERSION MAPPING
================================================================================

Current                          Recommended Next Step          Impact
---------------------------      ---------------------------    ------------------
DDL (33 calls)              →     Ecto Migrations               VERY HIGH (removes 33)
DML with Params (6 calls)   →     Repo.insert/update + Schema   HIGH (adds validation)
Simple Queries (4 calls)    →     Ecto.Query                    MEDIUM (cleaner)
Complex Queries (5 calls)   →     Ecto.Adapters.SQL.query!      NONE (already exists!)

================================================================================
FUNCTIONS NEEDING UPDATES
================================================================================

PUBLIC API FUNCTIONS (called from outside):
 1. create_unified_schema/1 - Calls create_*_* functions (lines 38-50)
 2. register_codebase/5 - DML (line 554)
 3. get_codebase_registry/2 - Query (line 591)
 4. list_codebases/1 - Query (line 643)
 5. update_codebase_status/3 - DML (line 687)
 6. insert_codebase_metadata/3 - DML (line 707)
 7. insert_graph_node/2 - DML (line 858)
 8. insert_graph_edge/2 - DML (line 892)
 9. semantic_search/4 - Query (line 933) [Already uses Ecto!]
10. find_similar_nodes/3 - Query (line 989)
11. multi_codebase_search/4 - Query (line 1043)
12. get_dependencies/2 - Query (line 1092)
13. get_dependents/2 - Query (line 1126)
14. detect_circular_dependencies/1 - Query (line 1160)
15. calculate_pagerank/3 - Query (line 1219)

PRIVATE HELPER FUNCTIONS (called internally):
- create_codebase_metadata_table/1 (line 56)
- create_graph_tables/1 (line 182)
- create_vector_search_tables/1 (line 258)
- create_performance_indexes/1 (line 298)
- create_apache_age_extension/1 (line 531)

================================================================================
PARAMETER COUNT ANALYSIS
================================================================================

Most Complex INSERT:
  Line 708: insert_codebase_metadata/3 - 55 PARAMETERS!
  ├─ 1-2: codebase_id, codebase_path
  ├─ 3: path
  ├─ 4-8: size, lines, language, last_modified, file_type
  ├─ 9-12: cyclomatic_complexity, cognitive_complexity, maintainability_index, nesting_depth
  ├─ 13-18: function_count, class_count, struct_count, enum_count, trait_count, interface_count
  ├─ 19-22: total_lines, code_lines, comment_lines, blank_lines
  ├─ 23-27: halstead_vocabulary, halstead_length, halstead_volume, halstead_difficulty, halstead_effort
  ├─ 28-31: pagerank_score, centrality_score, dependency_count, dependent_count
  ├─ 32-34: technical_debt_ratio, code_smells_count, duplication_percentage
  ├─ 35-36: security_score, vulnerability_count
  ├─ 37-39: quality_score, test_coverage, documentation_coverage
  ├─ 40-45: domains, patterns, features, business_context, performance_characteristics, security_characteristics
  ├─ 46-49: dependencies, related_files, imports, exports
  ├─ 50-54: functions, classes, structs, enums, traits
  └─ 55: vector_embedding

Medium Complexity INSERTs:
  Line 560: register_codebase - 7 parameters
  Line 859: insert_graph_node - 9 parameters
  Line 893: insert_graph_edge - 7 parameters

================================================================================
ECTO SCHEMA FIELD COUNTS
================================================================================

Needed Schema              Field Count    Complexity
------------------------  -----------    -----------
CodebaseMetadata           99             COMPLEX
CodebaseRegistry           10             SIMPLE
GraphNode                  9              MEDIUM
GraphEdge                  7              MEDIUM
GraphTypes                 3              SIMPLE (in registry)

TOTAL: 4 schemas + 1 lookup table

================================================================================
MIGRATION CONSOLIDATION PLAN
================================================================================

Proposed Migration 1: Core Tables (priv/repo/migrations/YYYYMMDDHHMMSS_create_code_search_schema.exs)
├─ codebase_metadata table (line 58)
├─ codebase_registry table (line 160)
├─ graph_nodes table (line 184)
├─ graph_edges table (line 207) with foreign keys
├─ graph_types table + seed data (lines 230, 244)
├─ vector_search table (line 260)
└─ vector_similarity_cache table (line 280)

Proposed Migration 2: Performance Indexes (priv/repo/migrations/YYYYMMDDHHMMSS_create_code_search_indexes.exs)
├─ All 25 index creation statements
└─ Optional: can be skipped during development, added before production

Proposed Migration 3: Apache AGE Extension (optional, priv/repo/migrations/YYYYMMDDHHMMSS_create_apache_age.exs)
├─ CREATE EXTENSION age (line 534)
└─ Optional: fails gracefully if extension unavailable

================================================================================

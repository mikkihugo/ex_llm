$schema: '../.moon/cache/schemas/project.json'

language: 'elixir'
type: 'application'

tasks:
  gleam.build:
    command: 'nix develop ..#dev --command just gleam-build'
    inputs:
      - 'src/**/*.gleam'
      - 'gleam.toml'
    outputs:
      - 'build/'

  gleam.test:
    command: 'nix develop ..#dev --command just gleam-test'
    deps:
      - 'gleam.build'
    inputs:
      - 'src/**/*.gleam'
      - 'test/**/*.gleam'
    local: false

  gleam.check:
    command: 'nix develop ..#dev --command just gleam-check'
    inputs:
      - 'src/**/*.gleam'

  deps.get:
    command: 'nix develop ..#dev --command just deps-get'
    inputs:
      - 'mix.exs'
      - 'mix.lock'
    outputs:
      - 'deps/'

  deps.compile:
    command: 'nix develop ..#dev --command just deps-compile'
    deps:
      - 'deps.get'
    inputs:
      - 'deps/**'
    outputs:
      - '.mix/**'

  compile:
    command: 'nix develop ..#dev --command just compile'
    deps:
      - 'deps.compile'
    inputs:
      - 'lib/**'
      - 'config/**'
      - 'priv/**'
      - 'src/**/*.gleam'
    outputs:
      - '_build/'

  test:
    command: 'nix develop ..#dev --command just test'
    deps:
      - 'compile'
    inputs:
      - 'test/**'
      - 'lib/**'
      - 'test/**/*.gleam'

  credo:
    command: 'nix develop ..#dev --command just credo'
    deps:
      - 'compile'
    inputs:
      - 'lib/**'
      - 'test/**'

  format:
    command: 'nix develop ..#dev --command just format'
    inputs:
      - 'lib/**'
      - 'test/**'
      - 'config/**'
    outputs:
      - 'lib/**'
      - 'test/**'
      - 'config/**'

  check:
    deps:
      - 'gleam.check'
      - 'test'
      - 'credo'

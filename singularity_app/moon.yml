$schema: '../.moon/cache/schemas/project.json'

language: 'elixir'
type: 'application'

tasks:
  gleam.build:
    command: 'nix develop ..#dev --command just gleam-build'
    inputs:
      - 'src/**/*.gleam'
      - 'gleam.toml'
    outputs:
      - 'build/'

  gleam.test:
    command: 'nix develop ..#dev --command just gleam-test'
    deps:
      - 'gleam.build'
    inputs:
      - 'src/**/*.gleam'
      - 'test/**/*.gleam'
    local: false

  gleam.check:
    command: 'nix develop ..#dev --command just gleam-check'
    inputs:
      - 'src/**/*.gleam'

  rust.build:
    command: 'nix develop ..#dev --command bash -c "cd ../rust && cargo build --release -p code_engine -p parser-code -p embedding_engine -p architecture_engine -p quality_engine -p prompt_engine"'
    # Note: Rustler auto-builds NIFs during mix compile
    # This task is for explicit NIF rebuilds when Rust code changes
    outputs:
      - 'priv/native/*.so'

  deps.get:
    command: 'nix develop ..#dev --command just deps-get'
    inputs:
      - 'mix.exs'
      - 'mix.lock'
    outputs:
      - 'deps/'

  deps.compile:
    command: 'nix develop ..#dev --command just deps-compile'
    deps:
      - 'deps.get'
    inputs:
      - 'deps/**'
    outputs:
      - '.mix/**'

  compile:
    command: 'nix develop ..#dev --command just compile'
    deps:
      - 'deps.compile'
      - 'rust.build'  # Rustler auto-builds NIFs during mix compile, but explicit for caching
    inputs:
      - 'lib/**'
      - 'config/**'
      - 'priv/**'
      - 'src/**/*.gleam'
    outputs:
      - '_build/'

  test:
    command: 'nix develop ..#dev --command just test'
    deps:
      - 'compile'
    inputs:
      - 'test/**'
      - 'lib/**'
      - 'test/**/*.gleam'

  credo:
    command: 'nix develop ..#dev --command just credo'
    deps:
      - 'compile'
    inputs:
      - 'lib/**'
      - 'test/**'

  format:
    command: 'nix develop ..#dev --command just format'
    inputs:
      - 'lib/**'
      - 'test/**'
      - 'config/**'
    outputs:
      - 'lib/**'
      - 'test/**'
      - 'config/**'

  check:
    deps:
      - 'gleam.check'
      - 'test'
      - 'credo'

defmodule Genesis.Schemas.ExperimentRecord do
  @moduledoc """
  ExperimentRecord Schema

  Tracks all experiments requested from Singularity instances.

  Each record represents:
  - A single improvement experiment
  - Proposed changes from a Singularity agent
  - Sandbox setup and execution
  - Final recommendation (merge/rollback)

  ## Fields

  - `experiment_id` - Unique identifier (generated by Singularity)
  - `instance_id` - Singularity instance that requested this
  - `status` - One of: pending, running, success, failed
  - `sandbox_path` - Location of isolated sandbox directory
  - `changes_files` - Files modified in this experiment
  - `baseline_commit` - Git state before changes
  """

  use Ecto.Schema
  import Ecto.Changeset

  @primary_key {:experiment_id, :string, autogenerate: false}

  schema "experiment_records" do
    field :instance_id, :string
    field :status, :string, default: "pending"
    field :risk_level, :string, default: "medium"
    field :experiment_type, :string, default: "improvement"
    field :description, :string

    # Sandbox information
    field :sandbox_path, :string
    field :baseline_commit, :string
    field :final_commit, :string

    # Proposed changes
    field :changes_files, {:array, :string}, default: []
    field :changes_description, :string
    field :estimated_impact, :float

    # Timestamps
    field :created_at, :utc_datetime_usec
    field :started_at, :utc_datetime_usec
    field :completed_at, :utc_datetime_usec

    # Rollback plan
    field :rollback_plan, :string

    # Association
    has_many :metrics, Genesis.Schemas.ExperimentMetrics, foreign_key: :experiment_id
  end

  @doc """
  Create a new experiment record from a Singularity request.
  """
  def create_changeset(attrs \\ %{}) do
    %__MODULE__{}
    |> cast(attrs, [
      :experiment_id,
      :instance_id,
      :status,
      :risk_level,
      :experiment_type,
      :description,
      :sandbox_path,
      :baseline_commit,
      :changes_files,
      :changes_description,
      :estimated_impact,
      :rollback_plan
    ])
    |> validate_required([:experiment_id, :instance_id])
  end

  @doc """
  Update an experiment record with execution results.
  """
  def update_changeset(record, attrs \\ %{}) do
    record
    |> cast(attrs, [
      :status,
      :sandbox_path,
      :baseline_commit,
      :final_commit,
      :started_at,
      :completed_at
    ])
  end
end

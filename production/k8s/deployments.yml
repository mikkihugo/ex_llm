---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: singularity
data:
  NATS_HOST: "nats-0.nats.singularity.svc.cluster.local"
  NATS_PORT: "4222"
  POSTGRES_DB_HOST: "postgresql-0.postgresql.singularity.svc.cluster.local"
  POSTGRES_DB_PORT: "5432"
  MIX_ENV: "prod"
  LOG_LEVEL: "info"

---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: singularity
type: Opaque
stringData:
  SECRET_KEY_BASE: "changeme-secret-key-base-min-64-chars-for-production"  # Change this!
  POSTGRES_PASSWORD: "changeme123!"
  DATABASE_URL: "postgres://postgres:changeme123!@postgresql-0.postgresql.singularity.svc.cluster.local:5432/singularity"
  CENTRALCLOUD_DATABASE_URL: "postgres://postgres:changeme123!@postgresql-0.postgresql.singularity.svc.cluster.local:5432/centralcloud"
  GENESIS_DATABASE_URL: "postgres://postgres:changeme123!@postgresql-0.postgresql.singularity.svc.cluster.local:5432/genesis"
  ANTHROPIC_API_KEY: "sk-ant-changeme"
  GOOGLE_AI_STUDIO_API_KEY: "changeme-google-api-key"
  OPENAI_API_KEY: "sk-proj-changeme"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: llm-server
  namespace: singularity
  labels:
    app: llm-server
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: llm-server
  template:
    metadata:
      labels:
        app: llm-server
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000

      containers:
        - name: llm-server
          image: LLM_SERVER_IMAGE
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 3000

          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets

          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1
              memory: 1Gi

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL

---
apiVersion: v1
kind: Service
metadata:
  name: llm-server
  namespace: singularity
spec:
  selector:
    app: llm-server
  ports:
    - name: http
      port: 3000
      targetPort: http
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: centralcloud
  namespace: singularity
  labels:
    app: centralcloud
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: centralcloud
  template:
    metadata:
      labels:
        app: centralcloud
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000

      containers:
        - name: centralcloud
          image: CENTRALCLOUD_IMAGE
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 4000

          env:
            - name: RELEASE_DISTRIBUTION
              value: "name"
            - name: RELEASE_NODE
              value: "centralcloud@127.0.0.1"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: CENTRALCLOUD_DATABASE_URL
            - name: FRAMEWORK_LEARNING_ENABLED
              value: "true"
            - name: PACKAGE_SYNC_ENABLED
              value: "true"
            - name: PACKAGE_SYNC_SCHEDULE
              value: "0 2 * * *"
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets

          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1
              memory: 1Gi

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3

          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

---
apiVersion: v1
kind: Service
metadata:
  name: centralcloud
  namespace: singularity
spec:
  selector:
    app: centralcloud
  ports:
    - name: http
      port: 4000
      targetPort: http
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: genesis
  namespace: singularity
  labels:
    app: genesis
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: genesis
  template:
    metadata:
      labels:
        app: genesis
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000

      containers:
        - name: genesis
          image: GENESIS_IMAGE
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 4000

          env:
            - name: RELEASE_DISTRIBUTION
              value: "name"
            - name: RELEASE_NODE
              value: "genesis@127.0.0.1"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: GENESIS_DATABASE_URL
            - name: METRICS_TRACKING_ENABLED
              value: "true"
            - name: AUTO_ROLLBACK_ENABLED
              value: "true"
            - name: ROLLBACK_THRESHOLD
              value: "0.90"
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets

          resources:
            requests:
              cpu: 1
              memory: 1Gi
            limits:
              cpu: 2
              memory: 2Gi

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3

          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

---
apiVersion: v1
kind: Service
metadata:
  name: genesis
  namespace: singularity
spec:
  selector:
    app: genesis
  ports:
    - name: http
      port: 4000
      targetPort: http
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: singularity
  namespace: singularity
  labels:
    app: singularity
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: singularity
  template:
    metadata:
      labels:
        app: singularity
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000

      containers:
        - name: singularity
          image: SINGULARITY_IMAGE
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 4000

          env:
            - name: RELEASE_DISTRIBUTION
              value: "name"
            - name: RELEASE_NODE
              value: "singularity@127.0.0.1"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DATABASE_URL
            - name: CENTRALCLOUD_URL
              value: "http://centralcloud:4000"
            - name: GENESIS_URL
              value: "http://genesis:4000"
            - name: LLM_SERVER_URL
              value: "http://llm-server:3000"
            - name: XLA_TARGET
              value: "cuda118"
            - name: PHX_HOST
              value: "localhost"
            - name: PHX_PORT
              value: "4000"
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets

          resources:
            requests:
              cpu: 2
              memory: 2Gi
            limits:
              cpu: 4
              memory: 4Gi

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3

          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

      # GPU node affinity (if using GPU)
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: accelerator
                    operator: In
                    values:
                      - nvidia-tesla-a100
                      - nvidia-rtx-4080

---
apiVersion: v1
kind: Service
metadata:
  name: singularity
  namespace: singularity
spec:
  selector:
    app: singularity
  ports:
    - name: http
      port: 4000
      targetPort: http
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: singularity-external
  namespace: singularity
spec:
  selector:
    app: singularity
  ports:
    - name: http
      port: 80
      targetPort: 4000
  type: LoadBalancer

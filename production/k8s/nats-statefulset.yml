---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nats-config
  namespace: singularity
data:
  nats.conf: |
    # NATS Server Configuration for Kubernetes
    port: 4222

    # Clustering
    cluster {
      port: 6222
    }

    # WebSocket support
    websocket {
      port: 4223
    }

    # Monitoring port
    http_port: 8222

    # JetStream configuration
    jetstream {
      store_dir: "/data/jetstream"
      max_memory_store: 1GB
      max_file_store: 10GB
    }

---
apiVersion: v1
kind: Service
metadata:
  name: nats
  namespace: singularity
spec:
  clusterIP: None  # Headless service for clustering
  selector:
    app: nats
  ports:
    - name: client
      port: 4222
      targetPort: 4222
    - name: cluster
      port: 6222
      targetPort: 6222
    - name: websocket
      port: 4223
      targetPort: 4223
    - name: http
      port: 8222
      targetPort: 8222

---
apiVersion: v1
kind: Service
metadata:
  name: nats-external
  namespace: singularity
spec:
  type: NodePort
  selector:
    app: nats
  ports:
    - name: client
      port: 4222
      targetPort: 4222
      nodePort: 30222
    - name: websocket
      port: 4223
      targetPort: 4223
      nodePort: 30223

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nats
  namespace: singularity
spec:
  serviceName: nats
  replicas: 1
  selector:
    matchLabels:
      app: nats
  template:
    metadata:
      labels:
        app: nats
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - nats
                topologyKey: kubernetes.io/hostname

      containers:
        - name: nats
          image: nats:latest-alpine
          imagePullPolicy: IfNotPresent

          ports:
            - name: client
              containerPort: 4222
            - name: cluster
              containerPort: 6222
            - name: websocket
              containerPort: 4223
            - name: http
              containerPort: 8222

          args:
            - "-c"
            - "/etc/nats/nats.conf"
            - "-D"

          resources:
            requests:
              cpu: 1
              memory: 512Mi
            limits:
              cpu: 2
              memory: 1Gi

          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - nats-cli rtt > /dev/null
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - nats-cli rtt > /dev/null
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3

          volumeMounts:
            - name: nats-config
              mountPath: /etc/nats
            - name: nats-data
              mountPath: /data

          securityContext:
            runAsUser: 1000
            allowPrivilegeEscalation: false

      volumes:
        - name: nats-config
          configMap:
            name: nats-config

  volumeClaimTemplates:
    - metadata:
        name: nats-data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
